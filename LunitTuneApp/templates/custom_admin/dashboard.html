{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <meta charset="utf-8" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#353E4B;color:#fff;font-family:'Poppins',sans-serif;height:100vh;display:flex;overflow:hidden}
    .sidebar{width:240px;background:#353E4B;height:100vh;overflow-y:auto;flex-shrink:0}
    .sidebar-header{padding:16px 20px;display:flex;align-items:center;gap:18px;border-bottom:1px solid rgba(255,255,255,.1);color:#BEF0FF}
    .logo{width:40px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px}
    .logo img{width:50px;height:50px}
    .sidebar-title{font-size:17px;font-weight:500;color:#BEF0FF}
    .new-item-btn{display:flex;align-items:center;gap:7px;background:#7AE0FF;color:#353E4B;border:none;padding:10px 20px;margin:16px;width:calc(100% - 32px);border-radius:5px;cursor:pointer;font-size:18px;font-weight:400;transition:background .2s}
    .new-item-btn:hover{background:#66d6fa}
    .menu-item{display:block;color:#bdc3c7;padding:12px 20px;text-decoration:none;font-size:14px;border:none;background:none;width:100%;text-align:left;cursor:pointer;transition:background .2s,color .2s;position:relative;font-weight:500}
    .menu-item:hover{background:rgba(122,224,255,.08);color:#ecf0f1}
    .menu-item.active{background:rgba(122,224,255,.12);color:#7AE0FF}
    .submenu{display:none;background:rgba(0,0,0,.1)}
    .submenu.open{display:block}
    .submenu .menu-item{padding-left:40px;font-size:13px}
    .menu-item.expandable{display:flex;align-items:center;justify-content:space-between}
    .menu-item.expandable::after{content:'▼';font-size:10px;color:#7f8c8d;transition:transform .2s}
    .menu-item.expandable.open::after{transform:rotate(180deg)}
    .content{flex:1;padding:20px;overflow-y:auto;background:#1a2332}
    .sidebar::-webkit-scrollbar{width:6px}
    .sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,.05)}
    .sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
    .sidebar::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.3)}
    .tracks-container{background:#2a3441;border-radius:8px;overflow:visible}
    .tracks-top{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1);background:#353E4B;display:flex;align-items:center;gap:12px;position:relative}
    .top-title{flex:0 0 auto}
    .top-title h2{margin:0;font-size:24px;font-weight:600;line-height:1.1;color:#fff}
    .top-title small{display:block;margin-top:4px;opacity:.7;font-size:12px}
    .top-controls{margin-left:auto;display:flex;align-items:center;gap:10px;flex-wrap:nowrap;min-width:0}
    .search-box{width: clamp(260px, 40vw, 554px);height:44px;padding:0 16px;display:flex;align-items:center;gap:12px;border:1px solid #3e4a59;border-radius:12px;background:#222731}
    .search-icon{width:18px;height:18px;opacity:.8}
    .tracks-top .search-box input{border:0;outline:0;box-shadow:none;background:transparent}
    .search-box input::placeholder{color:#9aa4b2}
    .btn{display:inline-flex;align-items:center;gap:8px;height:44px;padding:0 16px;border:1px solid #3e4a59;border-radius:12px;background:#222731;color:#718096;cursor:pointer;font-size:16px;line-height:24px;white-space:nowrap}
    .btn:hover{background:#2b3643}
    .btn--primary{background:#7AE0FF;color:#1c2a3a;border-color:#7AE0FF;font-weight:600;height:44px}
    .btn .ico{width:24px;height:24px;opacity:.9}
    .btn--date span{min-width:140px;text-align:center;display:inline-block}
    .tracks-table{width:100%;border-collapse:collapse}
    .tracks-table th{background:#3a4553;color:#BEF0FF;padding:12px 15px;text-align:left;font-weight:500;border-bottom:1px solid rgba(255,255,255,.1);font-size:14px}
    .tracks-table td{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,.05);color:#ccc;font-size:13px}
    .tracks-table tbody tr:hover{background:rgba(129, 113, 113, 0.05)}
    .tracks-table a,
    .tracks-table a:visited {
        color: #7AE0FF;          
        text-decoration: none;
    }
    .track-checkbox{width:16px;height:16px;accent-color:#7AE0FF}
    .track-name{color:#fff;font-weight:500}
    .action-btn{background:none;border:none;color:#7AE0FF;cursor:pointer;padding:5px;border-radius:3px;margin:0 2px}
    .action-btn:hover{background:rgba(122,224,255,.1)}
    .pagination{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-top:1px solid rgba(255,255,255,.1)}
    .page-numbers{display:flex;gap:5px}
    .page-btn{background:#555;color:#fff;border:none;padding:8px 12px;border-radius:3px;cursor:pointer;font-family:'Poppins',sans-serif}
    .page-btn.active{background:#7AE0FF;color:#353E4B}
    .delete-selected-btn{background:#F44336;color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:999}
    .modal-content{display:flex;flex-direction:column;align-items:flex-start;padding:30px;gap:20px;width:966px;height:832px;background:#353E4B;border-radius:10px;color:#fff;position:relative}
    .modal-header{display:flex;justify-content:space-between;align-items:center;width:906px;height:33px}
    .modal-header h2{font-weight:600;font-size:22px;line-height:33px;color:#fff;margin:0}
    .close-btn{position:relative;width:21px;height:21px;cursor:pointer}
    .close-btn::before,.close-btn::after{content:'';position:absolute;width:21px;height:4px;background:#B8B8B8;top:8.5px;left:0}
    .close-btn::before{transform:rotate(45deg)}
    .close-btn::after{transform:rotate(-45deg)}
    .modal-content form{display:flex;flex-direction:column;gap:24px;width:906px;height:719px}
    .form-input,.form-select-box,.form-textarea,.form-file-box{display:flex;flex-direction:column;gap:5px;width:100%}
    .form-input label,.form-select-box label,.form-textarea label,.form-file-box label{font-weight:300;font-size:14px;line-height:21px}
    input[type="text"],.form-select-box select,.form-textarea textarea,.form-file-box input[type="file"]{padding:10px 15px;background:#353E4B;border:1px solid #D4D4D4;border-radius:5px;color:#A1A1A1;font-weight:300;font-size:16px;line-height:24px;width:100%;height:40px}
    .form-select-box select{appearance:none;background-repeat:no-repeat;background-position:right 15px center;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23FFFFFF" d="M7 10l5 5 5-5z"/></svg>')}
    .form-row{display:flex;gap:20px;width:100%}
    .form-row .form-input,.form-row .form-select-box,.form-row .form-file-box{flex:1;max-width:443px}
    .form-textarea textarea{height:165px;resize:none}
    .form-buttons{display:flex;justify-content:flex-end;gap:8px;width:100%}
    .reset-btn,.save-btn{display:flex;justify-content:center;align-items:center;padding:6px 54px;border-radius:8px;font-weight:400;font-size:20px;line-height:30px;color:#000;border:none;cursor:pointer}
    .reset-btn{display:none;width:163px;height:42px;background:#FFCACB}
    .save-btn{width:157px;height:42px;background:#8EE6CC}
    .save-btn:hover{background:#7AD6BB}
    .reset-btn:hover{background:#FFB6B7}
    .date-popover{position:absolute;top:60px;right:20px;z-index:1000;background:#222731;border:1px solid #3e4a59;border-radius:12px;padding:12px;width:260px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .date-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:8px 0}
    .date-row label{font-size:13px;color:#9aa4b2}
    .date-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
    th.col-adult, td.col-adult{text-align:center}
    .filters-wrap{
      position: relative;             
    }

    .filters-popover{
      position: absolute;
      top: 52px;                      
      left: 0;
      z-index: 1100;                
      min-width: 320px;
      max-width: 420px;
      background: #222731;
      border: 1px solid #3e4a59;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      color: #fff;
    }

    .filters-popover .filter-row{
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .filters-popover label{
      font-size: 13px;
      color: #9aa4b2;
    }

    .filters-popover input[type="text"],
    .filters-popover select{
      height: 38px;
      padding: 8px 12px;
      background:#353E4B;
      border:1px solid #3e4a59;
      border-radius:8px;
      color:#A1A1A1;
    }

    .filters-popover .cb{
      display:flex; align-items:center; gap:8px;
      font-size: 13px;
    }
    /* === Customers toolbar & chips === */
    /* ----- ближе к сайдбару, уже, мягче ----- */
   /* ===== Customers: обновлённые стили под фигму ===== */

    /* Карточку делаем ближе к сайдбару и не на всю ширину */
    #customers-section .tracks-container{
      max-width: 1120px;
      width: calc(100% - 24px);
      margin: 8px 0 24px 12px;   /* ближе к левой кромке/сайдбару */
      border-radius: 14px;
      overflow: hidden;
      background:#2a3441;
    }

    /* Шапка карточки — без дубликата кнопки Add Customer */
    #customers-section .tracks-top{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); }
    #customers-section .tracks-top #btn-open-create-customer{ display:none !important; }

    /* Убираем строку "Show: All Customers" если есть */
    #customers-section .table-toolbar .subbar{ display:none !important; }

    /* Строка поиска/фильтра/кнопки — прижата к правому краю */
    #customers-section .table-toolbar{
      padding:8px 16px 12px;
      display:flex; justify-content:flex-end;
    }
    #customers-section .table-filters{
      display:flex; align-items:center; gap:10px; margin:0;
    }

    /* Компактное поле поиска + фикс «двойной рамки» */
    #customers-section .table-filters .search-box{
      flex:0 0 360px;         /* уже, чтобы не «раздувать» карточку */
      min-width:280px;
      max-width:420px;
      height:40px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid #3e4a59;
      background:#222731;
      display:flex; align-items:center; gap:10px;
    }
    #customers-section .table-filters .search-box input{
      width:100%;
      border:0 !important;
      outline:0 !important;
      box-shadow:none !important;
      background:transparent;
      padding:0;
      color:#e2e8f0;
    }
    #customers-section .table-filters .btn{ height:40px; }

    /* Таблица — ровные отступы и аккуратная сетка */
    #customers-section .tracks-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    #customers-section .tracks-table th{
      background:#3a4553;
      color:#BEF0FF;
      font-weight:500;
      font-size:14px;
      padding:12px 18px;
      text-align:left;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    #customers-section .tracks-table td{
      padding:12px 18px;
      font-size:13px;
      color:#cfd6df;
      border-bottom:1px solid rgba(255,255,255,.05);
      vertical-align:middle;
    }

    .pagination .page-btn{
      background:#222731; border:1px solid #3e4a59;
      border-radius:6px; min-width:34px; height:34px; padding:6px 10px;
    }
    .pagination .page-btn.active{
      background:#7AE0FF; color:#1c2a3a; border-color:#7AE0FF; font-weight:600;
    }

    .content{ padding:16px 20px 20px 12px; }

    @media (max-width: 1200px){
      #customers-section .tracks-container{ max-width: calc(100% - 24px); }
      #customers-section .table-filters .search-box{ flex:1 1 auto; min-width:240px; }
    }
    /* Мини-стили для поповера */
    .popover {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      z-index: 1100;
      min-width: 280px;
      max-width: 360px;
      background: #222731;
      border: 1px solid #3e4a59;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      color: #fff;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease-in-out;
    }

    /* Добавьте состояния для показа/скрытия */
    .popover.show,
    .popover:not([hidden]) {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .popover[hidden] {
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
    }
    .filters-wrap {
      position: relative;
    }
    /* Popover content */
    .popover-header {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 12px;
      color: #BEF0FF;
    }

    .popover-body {
      margin-bottom: 16px;
    }

    .popover-body label {
      display: block;
      font-size: 13px;
      color: #9aa4b2;
      margin-bottom: 6px;
    }

    .popover-body select {
      width: 100%;
      height: 36px;
      padding: 8px 12px;
      background: #353E4B;
      border: 1px solid #3e4a59;
      border-radius: 8px;
      color: #e2e8f0;
      font-family: inherit;
      cursor: pointer;
    }

    .popover-body select:focus {
      outline: none;
      border-color: #7AE0FF;
    }

    .popover-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .popover-footer button {
      flex: 1;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .popover-footer .clear-btn {
      background: #4a5568;
      color: #e2e8f0;
    }

    .popover-footer .clear-btn:hover {
      background: #5a6478;
    }

    .popover-footer .apply-btn {
      background: #7AE0FF;
      color: #1c2a3a;
    }

    .popover-footer .apply-btn:hover {
      background: #66d6fa;
    }
      @media (max-width: 768px) {
      .table-filters {
        flex-wrap: wrap;
      }
      
      .search-box {
        flex: 1 1 100%;
        order: -1;
        margin-bottom: 8px;
      }
      
      .customer-filters-popover {
        right: auto;
        left: 0;
        min-width: 100%;
      }
    }

    /* Animation for smooth interactions */
    .btn {
      transition: all 0.2s ease;
    }

    .btn:active {
      transform: translateY(1px);
    }

    /* Focus states for accessibility */
    .btn:focus,
    .popover-footer button:focus,
    .popover-body select:focus {
      outline: 2px solid #7AE0FF;
      outline-offset: 2px;
    }
    #customerFiltersClear {
      background: #4a5568;
      color: #e2e8f0;
    }

    #customerFiltersClear:hover {
      background: #5a6478;
    }

    #customerFiltersApply {
      background: #7AE0FF;
      color: #1c2a3a;
    }

    #customerFiltersApply:hover {
      background: #66d6fa;
    }
    /* меньше ширина и не растягивать по высоте */
    #customerCreateModal .modal-content,
    #customerEditModal  .modal-content{
      width: min(950px, calc(100% - 32px)); /* было широко — делаем компактнее */
      height: auto;                         /* ключ: по контенту */
      min-height: unset;                    /* снять возможный глобальный min-height */
      max-height: 45vh;                     /* запас, если контента станет больше */
      align-self: center;                   /* на всякий случай — не тянуться по flex */
    }

    /* чуть компактнее внутренние отступы (не обязательно, но уберёт воздух) */
    #customerCreateModal .modal-header,
    #customerEditModal  .modal-header{ padding:14px 16px; }
    #customerCreateModal form,
    #customerEditModal  form{ padding:16px; }

   /* Узкая “рамка” для раздела Playlists */
    #playlists-section .tracks-container,
    #playlists-section .table-container,
    #playlists-section .panel,
    #playlists-grid{
      max-width:1100px;      /* здесь регулируешь ширину */
      margin:0 auto;         /* центрируем */
    }

    /* сам грид карточек — как раньше */
    #playlists-grid{
      display:grid !important;
      grid-template-columns:repeat(auto-fill, minmax(160px,1fr)) !important;
      gap:16px !important;
      padding:16px !important;
    }

    /* карточка + оверлей действий */
    #playlists-grid .pl-card{
      position:relative;               /* нужно для оверлея */
      background:#2b3441;
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    #playlists-grid .pl-card:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 26px rgba(0,0,0,.32);
    }

    /* квадратные обложки */
    #playlists-grid .pl-cover{
      width:100% !important;
      aspect-ratio:1/1;
      object-fit:cover;
      display:block;
      border-radius:10px;
      margin-bottom:8px;
      background:#1f2631;
    }
    #playlists-grid .pl-title{font-size:14px;color:#fff;font-weight:600;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    #playlists-grid .pl-sub{font-size:12px;color:#9aa4b2;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* Кнопки CRUD на карточке */
    .pl-actions{
      position:absolute; top:8px; right:8px; display:flex; gap:6px;
      opacity:0; transition:opacity .15s ease;
    }
    .pl-card:hover .pl-actions{ opacity:1; }

    .pl-action{
      width:30px; height:30px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); cursor:pointer;
    }
    .pl-action img{ width:16px; height:16px; display:block; }



    #playlistCreateModal .modal-content{
      width:860px !important;        
      max-width:min(96vw, 920px);
      height:auto !important;        
      background:#2a3441;           
      border-radius:12px;
    }
    #playlistCreateModal .modal-header{
      width:100% !important;         
      height:auto !important;
      margin-bottom:10px;
    }
    #playlistCreateModal .modal-header h2{
      margin:0; font-weight:600; font-size:22px; color:#fff;
    }
    #playlistCreateModal form{
      width:100% !important;        
      height:auto !important;        
      display:flex; flex-direction:column; gap:16px;
    }

    #playlistCreateModal label{font-size:13px; color:#BEF0FF}
    #playlistCreateModal input[type="text"],
    #playlistCreateModal input[type="search"],
    #playlistCreateModal textarea{
      height:40px;
      padding:10px 14px;
      background:#222731;
      border:1px solid #3e4a59;
      border-radius:12px;
      color:#e2e8f0;
      outline:0;
    }
    #playlistCreateModal input::placeholder,
    #playlistCreateModal textarea::placeholder{ color:#9aa4b2; }
    #playlistCreateModal textarea{ min-height:40px; resize:vertical; }

    #playlistCreateModal .pl-cover-uploader{
      position:relative; width:200px; height:200px;
      background:#222731; border:1px solid #3e4a59; border-radius:12px;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    #playlistCreateModal #pl-cover-preview{max-width:100%; max-height:100%; display:none;}
    #playlistCreateModal #pl_cover{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    #playlistCreateModal .pl-picker{
      display:grid;
      grid-template-columns:repeat(2, minmax(320px, 1fr));
      gap:16px;
      align-items:start;
    }
    #playlistCreateModal .pl-results,
    #playlistCreateModal .pl-selected,
    #playlistCreateModal #pl_results_list,
    #playlistCreateModal #pl_selected_chips{
      min-width:0;        /* критично, иначе соседняя колонка схлопывается */
    }
    #playlistCreateModal .pl-results,
    #playlistCreateModal .pl-selected{
      background:#222731; border:1px solid #3e4a59; border-radius:12px; padding:10px; min-height:220px;
    }
    #playlistCreateModal .pl-results-head{
      font-weight:600; color:#BEF0FF; font-size:13px; margin-bottom:8px;
    }
    #playlistCreateModal #pl_results_list{
      list-style:none; max-height:280px; overflow:auto; display:flex; flex-direction:column; gap:6px;
    }
    #playlistCreateModal .pl-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 10px; border:1px solid #323e4e; border-radius:10px; background:#2a3240;
    }
    #playlistCreateModal .pl-row .meta,
    #playlistCreateModal .pl-row .name,
    #playlistCreateModal .pl-row .artist,
    #playlistCreateModal .pl-chip .truncate{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #playlistCreateModal .pl-row button{
      background:#7AE0FF; border:1px solid #7AE0FF; color:#1c2a3a;
      border-radius:10px; height:30px; padding:0 10px; font-weight:600; cursor:pointer;
    }
    #playlistCreateModal .pl-row button.remove{ background:#FFCACB; border-color:#FFCACB; color:#3a1c1c; }

    #playlistCreateModal .pl-chips{ display:flex; flex-wrap:wrap; gap:6px; }
    #playlistCreateModal .pl-chip{
      display:flex; align-items:center; gap:6px;
      background:#2a3240; border:1px solid #323e4e; border-radius:999px;
      color:#e2e8f0; font-size:12px; padding:6px 10px; max-width:100%;
    }
    #playlistCreateModal .pl-chip .x{
      width:16px; height:16px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center;
      background:#FFCACB; color:#2b1a1a; font-weight:700; cursor:pointer;
    }

    @media (max-width: 980px){
      #playlistCreateModal .pl-picker{ grid-template-columns:1fr; }
      #playlistCreateModal .modal-content{ width:min(92vw, 860px) !important; }
    }
    #playlistCreateModal .form-buttons{
  display:flex; justify-content:flex-end; gap:12px; margin-top:8px;
}

  #playlistCreateModal .save-btn,
  #playlistCreateModal .reset-btn{
    display:inline-flex; align-items:center; justify-content:center;
    height:40px; padding:0 16px;
    border-radius:10px; border:0; cursor:pointer; font-weight:600;
    white-space:nowrap;          /* ← не переносить строку */
    width:auto; max-width:none;  /* ← убрать возможную фикс. ширину */
  }

  /* Цвета */
  #playlistCreateModal .save-btn{ background:#96F0DD; color:#0d1b1e; }
  #playlistCreateModal .save-btn:hover{ filter:brightness(.95); }
  #playlistCreateModal .reset-btn{
    background:transparent; border:1px solid #3e4a59; color:#cbd5e1;
  }
  /* Modal layout helpers */
  .modal-card { max-width: 860px; width: 100%; margin: 0 auto; background: #2b3440; padding: 24px; border-radius: 8px; position: relative; }
  .modal-card h3 { margin: 0 0 16px; }
  .modal-card .close { position:absolute; right: 14px; top: 12px; font-size: 22px; background: transparent; border: 0; color: #cbd5e1; cursor: pointer; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; }
  .form-grid .full { grid-column: 1 / -1; }
  .form-grid label { display:block; font-size:12px; color:#cbd5e1; margin-bottom:6px; }
  .form-grid input[type="text"],
  .form-grid input[type="file"],
  .form-grid textarea { width:100%; border:1px solid #3b4452; background:#394352; color:#e5e7eb; padding:8px 10px; border-radius:6px; }

  .form-grid .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:6px; }
  .btn { padding:10px 16px; border-radius:8px; border:0; cursor:pointer; }
  .btn.primary { background:#7ce7cf; color:#033; }
  .btn.ghost { background:transparent; color:#cbd5e1; border:1px solid #475569; }
  /* ===== KPIs ===== */
#dash-overview .kpi-grid{
  display:grid;
  grid-template-columns:repeat(6,minmax(160px,1fr));
  gap:12px;
  margin:12px 0;
}
@media (max-width:1400px){ #dash-overview .kpi-grid{ grid-template-columns:repeat(3,1fr); } }
@media (max-width:760px){  #dash-overview .kpi-grid{ grid-template-columns:repeat(2,1fr); } }

#dash-overview .kpi{
  background:#121a2b;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:12px;
}
#dash-overview .kpi .label{color:#94a3b8;font-size:12px}
#dash-overview .kpi .value{font-size:22px;font-weight:700;margin-top:4px}
#dash-overview .kpi .sub{color:#8a97ab;font-size:12px;margin-top:2px}

/* ===== Top toolbar & buttons ===== */
#dash-overview .dash-controls{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
#dash-overview .dash-controls .qa{margin-left:auto;display:flex;gap:8px}

#dash-overview .btn{
  border:1px solid rgba(255,255,255,.10);
  background:#121a2b;
  color:#e5e7eb;
  border-radius:10px;
  padding:8px 12px;
  min-height:36px;
  cursor:pointer;
}
#dash-overview .btn:hover{border-color:rgba(255,255,255,.18)}
#dash-overview .btn.primary{background:#3b82f6;border-color:#3b82f6;color:#0b1020}
#dash-overview .btn.ghost{background:#0e1626}

/* ===== Dashboard cards/layout ===== */
#dash-overview .dash-grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:16px;
}
@media (max-width:1200px){ #dash-overview .dash-grid{ grid-template-columns:1fr; } }

#dash-overview .card{
  background:#121a2b;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:12px;
}
#dash-overview .card-head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
#dash-overview .card-head .title{font-weight:700}

/* Tabs / Chips */
#dash-overview .tabs{display:flex;gap:6px}
#dash-overview .tab,
#dash-overview .chip{
  display: inline-flex;
  flex: 0 0 auto;
  justify-content: center;
  align-items: center;
  border:1px solid rgba(255,255,255,.12);
  background:transparent;
  color:#9aa8be;
  border-radius:999px;
  height: 28px;
  line-height: 28px;
  padding:0px 10px;
  font-size:12px;
  cursor:pointer;
  white-space: nowrap;
}
#dash-overview .tab.active,
#dash-overview .chip.active{
  background:#3b82f6;
  border-color:#3b82f6;
  color:#0b1020;
}
#dash-overview .switch{display:flex;gap:6px;flex-wrap:wrap;}

/* Line chart */
#dash-overview .line-wrap{
  height:220px;
  background:#0e1626;
  border:1px dashed rgba(255,255,255,.10);
  border-radius:10px;
  padding:8px;
}
#dash-overview #dash-line{width:100%;height:100%}

/* Top content table */
#dash-overview .table.compact th,
#dash-overview .table.compact td{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
#dash-overview #dash-top-table td:nth-child(1),
#dash-overview #dash-top-table td:nth-child(2){
  max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

/* Recent activity */
#dash-overview .list.slim{list-style:none;margin:0;padding:0}
#dash-overview .list.slim li{
  display:flex;justify-content:space-between;gap:10px;
  padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08);
}

/* Moderation queue */
#dash-overview .queue{display:grid;grid-template-columns:1fr 1fr;gap:8px}
#dash-overview .queue .q{
  background:#0e1626;
  border:1px solid rgba(255,255,255,.08);
  border-radius:10px;
  padding:12px;
}
#dash-overview .queue .q .ttl{font-size:12px;color:#9aa8be}
#dash-overview .queue .q .num{font-size:18px;font-weight:700;margin-top:4px}

/* ===== Dashboard • Date popover (DE-DUPED) ===== */
/* Убрали старый #dash-overview .popover — остаётся только этот блок */
#dash-overview #dashDatePopover{
  position:fixed;          /* координаты задаёт JS через left/top */
  width:320px;
  background:#121a2b;
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 12px 32px rgba(0,0,0,.45);
  border-radius:12px;
  padding:14px;
  z-index:60;
}

#dash-overview #dashDatePopover::before{
  content:"";
  position:absolute;
  top:-6px; left:22px;
  width:10px; height:10px;
  background:#121a2b;
  border-left:1px solid rgba(255,255,255,.10);
  border-top: 1px solid rgba(255,255,255,.10);
  transform:rotate(45deg);
}

/* строки с лейблом и инпутом — в гриде */
#dash-overview #dashDatePopover .row{
  display:grid;
  grid-template-columns:72px 1fr;
  align-items:center;
  gap:10px;
  margin:8px 0;
}
#dash-overview #dashDatePopover label{ color:#9aa8be; font-size:12px; }

/* поля даты */
#dash-overview #dashDatePopover input[type="date"]{
  width:100%;
  height:36px;
  padding:0 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.12);
  background:#0e1626;
  color:#e5e7eb;
  outline:none;
}
#dash-overview #dashDatePopover input[type="date"]:focus{
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.25);
}
#dash-overview #dashDatePopover input[type="date"]::-webkit-calendar-picker-indicator{
  filter:invert(1) opacity(.7);
}

/* блок с кнопками — сетка 2×2 */
#dash-overview #dashDatePopover .row.gap{
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-top:12px;
}

/* кнопки в поповере */
#dash-overview #dashDatePopover .btn{
  height:36px;
  padding:0 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.12);
  background:#0e1626;
  color:#e5e7eb;
  cursor:pointer;
}
#dash-overview #dashDatePopover .btn:hover{ border-color:rgba(255,255,255,.22); }
#dash-overview #dashDatePopover .btn.primary{
  background:#3b82f6;border-color:#3b82f6;color:#0b1020;
}
#dash-overview #dashDatePopover .btn.ghost{ background:#0e1626; }

/* узкие экраны — кнопки в колонку */
@media (max-width:420px){
  #dash-overview #dashDatePopover{ width:92vw; }
  #dash-overview #dashDatePopover .row.gap{ grid-template-columns:1fr; }
}
#customerFiltersPopover.popover{
  position: fixed;     
  bottom: auto;
  right:  auto;
  transform: none;     

}

/* Базовое — центрирование модалки */
#modal, #editModal { display:none; }
.modal{
  position:fixed; inset:0; z-index:1100;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.55);
}

/* Компактная коробка именно для модалок треков */
#modal .modal-content,
#editModal .modal-content{
  width: min(950px, 92vw);
  height: auto !important;       /* убираем принудительную высоту */
  min-height: 0 !important;      /* и любой высокий min-height */
  max-height: none !important;   /* на случай max-height */
  padding: 20px;
}

/* Чуть компактнее поля внутри */
#editModal .form-row{ 
  display:grid; grid-template-columns: 1fr 1fr; gap:14px;
  margin-bottom: 12px;
}
#editModal .form-input{ margin-bottom: 10px; }
#editModal .form-buttons{ margin-top: 8px; justify-content:flex-end; }
/* ===== Artist page: scoped only to the artists section ===== */
#artists-section {
  --bg: #1f2a36;
  --bg-soft: #253243;
  --bg-softer: #2B3A4E;
  --text: #e8eef5;
  --muted: #a6b3c3;
  --brand: #6ee7b7;
  --line: rgba(255,255,255,0.06);
  --chip: rgba(110,231,183,0.14);
}

/* карточка артиста */
#artists-section .artist-card {
  display: grid;
  grid-template-columns: 88px 1fr;
  gap: 16px;
  align-items: start;
  background: var(--bg-soft);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 16px;
  margin: 12px 0 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}

#artists-section .artist-avatar {
  width: 88px;
  height: 88px;
  border-radius: 12px;
  object-fit: cover;
  border: 1px solid var(--line);
}

#artists-section .artist-head {
  display: grid;
  gap: 8px;
}

#artists-section .artist-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.2;
}

#artists-section .artist-desc {
  font-size: 13px;
  color: var(--muted);
  max-width: 1100px;
}

#artists-section .artist-stats {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}
#artists-section .stat-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text);
  background: var(--chip);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line);
}

/* табы */
#artists-section .artist-tabs {
  display: flex;
  gap: 8px;
  margin: 4px 0 12px;
}
#artists-section .artist-tab {
  appearance: none;
  border: 1px solid var(--line);
  background: var(--bg-soft);
  color: var(--muted);
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 13px;
  line-height: 1;
  transition: all .18s ease;
  cursor: pointer;
}
#artists-section .artist-tab .count {
  margin-left: 6px;
  font-weight: 700;
  color: var(--text);
}
#artists-section .artist-tab:hover { transform: translateY(-1px); }
#artists-section .artist-tab.active {
  background: var(--bg-softer);
  color: var(--text);
  border-color: rgba(110,231,183,0.35);
  box-shadow: inset 0 0 0 1px rgba(110,231,183,0.2);
}

/* таблица контента */
#artists-section .artist-content {
  background: var(--bg-soft);
  border: 1px solid var(--line);
  border-radius: 16px;
  overflow: hidden;
}

/* уточнение текущей таблицы */
#artists-section .artist-content table {
  width: 100%;
  border-collapse: collapse;
}
#artists-section .artist-content thead th {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .02em;
  text-transform: none;
  color: var(--muted);
  background: rgba(255,255,255,0.02);
  border-bottom: 1px solid var(--line);
  padding: 10px 14px;
}
#artists-section .artist-content tbody td {
  font-size: 14px;
  color: var(--text);
  padding: 12px 14px;
  border-bottom: 1px solid var(--line);
  vertical-align: middle;
}
#artists-section .artist-content tbody tr:hover {
  background: rgba(255,255,255,0.03);
}
#artists-section .meta {
  color: var(--muted);
  font-size: 13px;
}

/* эмпти-стейт */
#artists-section .empty {
  padding: 28px 16px;
  text-align: center;
  color: var(--muted);
}

/* компактные бейджи в ячейках */
#artists-section .badge {
  display: inline-block;
  padding: 3px 8px;
  font-size: 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,0.04);
  color: var(--text);
}

/* резина */
@media (max-width: 780px) {
  #artists-section .artist-card {
    grid-template-columns: 64px 1fr;
    padding: 12px;
    gap: 12px;
  }
  #artists-section .artist-avatar { width: 64px; height: 64px; }
  #artists-section .artist-name { font-size: 18px; }
  #artists-section .artist-tabs { flex-wrap: wrap; }
  #artists-section .artist-content thead { display: none; }
  #artists-section .artist-content tbody tr {
    display: grid;
    grid-template-columns: 1fr 100px;
    gap: 8px;
    padding: 10px 12px;
  }
  #artists-section .artist-content tbody td {
    border: none;
    padding: 4px 0;
  }
}

/* ===== Artist Detail: вписываемся в фикс-коробку (966×832) ===== */
#artistDetailModal{ display:flex; align-items:center; justify-content:center; }

/* .modal-content уже 966×832 и имеет padding:30px; gap:20px
   => внутренняя «рабочая» область = 906 по ширине и 772 по высоте.
   33px занимает header, 20px — межблочный gap,
   остаётся 719px — делаем прокрутку тела. */

/* Шапка 906×33 — строго по глобалке */
#artistDetailModal .modal-header{
  width: 906px;
  height: 33px;
  padding: 0;                        /* чтобы не распухала по высоте */
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,.08);
}

/* Заголовок и аватар ужимаем под 33px */
#artistDetailModal .modal-header h2{
  display: flex; align-items: center; gap: 8px;
  margin: 0;
  font-size: 16px; line-height: 1; font-weight: 600;
  max-width: calc(906px - 36px);     /* чтобы текст не лез под крестик */
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
#artistDetailModal #ad-photo{
  width: 24px; height: 24px; border-radius: 6px; object-fit: cover; display: none;
}

/* Крестик уже 21×21 — оставим как есть */

/* Тело: ровно 906×719, прокрутка по вертикали */
#artistDetailModal .ad-body{
  width: 906px;
  height: 719px;
  overflow: auto;
}

/* Табы — липнут к верху тела, не увеличивают общую высоту */
#artistDetailModal .ad-tabs{
  position: sticky; top: 0;
  display: flex; gap: 8px;
  padding: 6px 0 8px;
  background: #353E4B;              /* тот же фон, что и модалка */
  border-bottom: 1px solid rgba(255,255,255,.08);
  z-index: 1;
}
#artistDetailModal .ad-tab{
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 13px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: #e7edf3;
  cursor: pointer;
}
#artistDetailModal .ad-tab.active{
  background: rgba(255,255,255,.10);
  border-color: rgba(110,231,183,.35);
  box-shadow: inset 0 0 0 1px rgba(110,231,183,.18);
}

/* Таблица — настоящая table без горизонтального скролла */
#artistDetailModal .ad-table{
  display: table;
  width: 100%;
  table-layout: fixed;
  border-collapse: collapse;
  margin-top: 6px;
}
#artistDetailModal .ad-table thead{ display: table-header-group; }
#artistDetailModal .ad-table tbody{ display: table-row-group; }
#artistDetailModal .ad-table tr   { display: table-row; }

#artistDetailModal .ad-table th,
#artistDetailModal .ad-table td{
  padding: 10px 12px;
  font-size: 13px;
  border-bottom: 1px solid rgba(255,255,255,.07);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
#artistDetailModal .ad-table thead th{
  font-weight: 600; color: rgba(255,255,255,.75);
  background: transparent;
}

/* Узкие колонки и выравнивание чисел */
#artistDetailModal .ad-table th:nth-child(1){ width: 44%; }
#artistDetailModal .ad-table th:nth-child(2){ width: 36%; }
#artistDetailModal .ad-table th:nth-child(3){ width: 10%; text-align: right; }
#artistDetailModal .ad-table th:nth-child(4){ width: 10%; text-align: right; }
#artistDetailModal .ad-table td:nth-child(3),
#artistDetailModal .ad-table td:nth-child(4){ text-align: right; }

#artistDetailModal .ad-table tbody tr:hover{
  background: rgba(255,255,255,.03);
}

/* Мобилка: ширину/высоту глобалки не трогаем — только косметика */
@media (max-width: 640px){
  #artistDetailModal .modal-header h2{ font-size: 15px; }
  #artistDetailModal #ad-photo{ width: 20px; height: 20px; }
  #artistDetailModal .ad-table th:nth-child(2),
  #artistDetailModal .ad-table td:nth-child(2){ display:none; } /* прячем Meta/Host */
}



  </style>
</head>
<body>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <img src="/media/iconsLuniTune/Logo.png" alt="Logo">
    </div>
    <span class="sidebar-title">Admin Dashboard</span>
  </div>

  <button class="new-item-btn" id="btn-new-playlist"><span>+</span> New Item</button>
  <a href="#customers-section" class="menu-item" id="nav-customers">Customers</a>

  <button class="menu-item expandable">Elements</button>
  <div id="elements" class="submenu">
    <a href="#dashboard-section" class="menu-item" id="nav-tracks">Tracks</a>
    <a href="#artists-section" class="menu-item" id="nav-artists">Artists</a>
    <!-- <a href="#" class="menu-item" data-by="albumid">Albums</a>
    <a href="#" class="menu-item" data-by="genreid">Genres</a> -->
    <a href="#playlists-section" class="menu-item" id="nav-playlists">Playlists</a>
    <a href="#audiobooks-section" class="menu-item" id="nav-audiobooks">Audiobooks</a>
    <a href="#podcasts-section" class="menu-item" id="nav-podcasts">Podcasts</a>
  </div>

  <a href="#dash-overview" class="menu-item" id="nav-dashboard">Dashboard</a>
  <form action="{% url 'logout' %}" method="post" style="margin:0">
    {% csrf_token %}
    <button type="submit" class="menu-item" id="nav-logout">Quit</button>
  </form>
</div>

<div class="content">
  <!-- =================== TRACKS SECTION (ранее dashboard-section) =================== -->
  <div id="dashboard-section">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Track</h2>
          <small>List track</small>
        </div>

        <div class="top-controls">
          <div class="search-box">
            <img class="search-icon" src="/media/iconsLuniTune/Search.png" alt="">
            <input id="searchInput" type="text" placeholder="Search by ID, product, or others...">
          </div>

          <div class="filters-wrap">
            <button class="btn" id="filtersBtn">
              <img class="ico" src="/media/iconsLuniTune/filter.png" alt="">
              Filters
            </button>

            <div id="filtersPopover" class="filters-popover" hidden>
              <div class="filter-row">
                <label>Artist ID</label>
                <input id="fArtist" type="text">
              </div>
              <div class="filter-row">
                <label>Album ID</label>
                <input id="fAlbum" type="text">
              </div>
              <div class="filter-row">
                <label>Genre ID</label>
                <input id="fGenre" type="text">
              </div>
              <div class="filter-row">
                <label>Adult</label>
                <select id="fAdult">
                  <option value="">All</option>
                  <option value="true">Adult</option>
                  <option value="false">Non-adult</option>
                </select>
              </div>
              <div class="filter-row">
                <label class="cb">
                  <input id="fHasAudio" type="checkbox">
                  With audio only
                </label>
              </div>

              <div class="date-actions">
                <button type="button" id="filtersClear" class="btn">Clear</button>
                <button type="button" id="filtersApply" class="btn btn--primary">Apply</button>
              </div>
            </div>
          </div>

          <button class="btn btn--date" id="dateRangeBtn">
            <img class="ico" src="/media/iconsLuniTune/calendar.png" alt="">
            <span>All time</span>
          </button>

          <button class="btn btn--primary" onclick="openModal()">
            <img class="ico" src="/media/iconsLuniTune/u_plus.png" alt="">
            New Track
          </button>
        </div>

        <div id="datePopover" class="date-popover" style="display:none;">
          <div class="date-row">
            <label>Start</label>
            <input type="date" id="dateStart">
          </div>
          <div class="date-row">
            <label>End</label>
            <input type="date" id="dateEnd">
          </div>
          <div class="date-actions">
            <button type="button" id="dateClear" class="btn">Clear</button>
            <button type="button" id="dateApply" class="btn btn--primary">Apply</button>
          </div>
        </div>
      </div>

      <div id="main-view">
        <table class="tracks-table" id="tracks-main-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="track-checkbox" id="select-all"></th>
              <th>Name</th>
              <th>artistid</th>
              <th>genreid</th>
              <th>albumid</th>
              <th>PlaysNum</th>
              <th class="col-adult">Adult</th>
              <th>ID</th>
              <th>Time</th>
              <th>Play</th>
              <th>Table Edit</th>
            </tr>
          </thead>
          <tbody id="tracks-tbody"></tbody>
        </table>

        <div class="pagination" id="tracks-pagination"></div>
      </div>

      <div id="list-view" hidden>
        <table class="tracks-table">
          <thead>
            <tr id="lp-head"></tr>
          </thead>
          <tbody id="lp-body"></tbody>
        </table>
      </div>

      <div class="pagination" id="lp-pagination"></div>
    </div>
  </div>

  <!-- =================== AUDIOBOOKS SECTION =================== -->
  <div id="audiobooks-section" style="display:none;">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Audiobooks</h2>
          <small>List of audiobooks</small>
        </div>
        <div class="top-controls">
          <div class="search-box">
            <img class="search-icon" src="/media/iconsLuniTune/Search.png" alt="">
            <input id="searchAudiobookInput" type="text" placeholder="Search by title, author, narrator...">
          </div>
          <button class="btn btn--primary" id="btn-open-create-audiobook">
            <img class="ico" src="/media/iconsLuniTune/u_plus.png" alt="">
            New Audiobook
          </button>
        </div>
      </div>

      <table class="tracks-table" id="audiobooks-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-audiobooks"></th>
            <th>Title</th>
            <th>Author</th>
            <th>Genre</th>
            <th>Chapter</th>
            <th>Plays</th>
            <th class="col-adult">Adult</th>
            <th>ID</th>
            <th>Time</th>
            <th>Play</th>
            <th>Table Edit</th>
          </tr>
        </thead>
        <tbody id="audiobooks-tbody"></tbody>
      </table>
      <div class="pagination" id="audiobooks-pagination"></div>
    </div>
  </div>

  <!-- =================== PODCAST SECTION =================== -->
  <div id="podcasts-section" style="display:none;">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Podcasts</h2>
          <small>List of episodes</small>
        </div>
        <div class="top-controls">
          <div class="search-box">
            <img class="search-icon" src="/media/iconsLuniTune/Search.png" alt="">
            <input id="searchPodcastInput" type="text" placeholder="Search by title, show, host...">
          </div>
          <button class="btn btn--primary" id="btn-open-create-podcast">
            <img class="ico" src="/media/iconsLuniTune/u_plus.png" alt="">
            New Episode
          </button>
        </div>
      </div>

      <table class="tracks-table" id="podcasts-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-podcasts"></th>
            <th>Title</th>
            <th>Host</th>
            <th>Genre</th>
            <th>Episode</th>
            <th>Plays</th>
            <th class="col-adult">Adult</th>
            <th>ID</th>
            <th>Time</th>
            <th>Play</th>
            <th>Table Edit</th>
          </tr>
        </thead>
        <tbody id="podcasts-tbody"></tbody>
      </table>
      <div class="pagination" id="podcasts-pagination"></div>
    </div>
  </div>

  <!-- =================== ARTISTS SECTION =================== -->
  <div id="artists-section" style="display:none;">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Artists</h2>
          <small>List of artists</small>
        </div>

        <div class="top-controls">
          <div class="search-box">
            <img class="search-icon" src="/media/iconsLuniTune/Search.png" alt="">
            <input id="searchArtistInput" type="text" placeholder="Search by name or description...">
          </div>

          <button class="btn btn--primary" id="btn-open-create-artist">
            <img class="ico" src="/media/iconsLuniTune/u_plus.png" alt="">
            New Artist
          </button>
        </div>
      </div>

      <table class="tracks-table" id="artists-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-artists"></th>
            <th>Photo</th>
            <th>Name</th>
            <th>Description</th>
            <th>Listeners</th>
            <th>ID</th>
            <th>Table Edit</th>
          </tr>
        </thead>
        <tbody id="artists-tbody"></tbody>
      </table>
      <!-- Artist Detail Modal -->
      <div id="artistDetailModal" class="modal" style="display:none;">
        <div class="modal-content ad-modal">

          <div class="modal-header ad-header">
            <h2 class="ad-title">
              <img id="ad-photo" class="ad-photo" alt="">
              <span id="ad-name"></span>
            </h2>
            <span class="close-btn" id="ad-close"></span>
          </div>

          <div id="artist-detail" class="ad-body">

            <div class="ad-tabs">
              <button class="ad-tab active" data-adtab="tracks">
                Tracks (<span id="ad-count-tracks">0</span>)
              </button>
              <button class="ad-tab" data-adtab="audiobooks">
                Audiobooks (<span id="ad-count-ab">0</span>)
              </button>
              <button class="ad-tab" data-adtab="podcasts">
                Podcasts (<span id="ad-count-pc">0</span>)
              </button>
            </div>

            <div id="ad-tab-tracks" class="ad-panel">
              <table class="ad-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Meta</th>
                    <th>Plays</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="ad-tracks"></tbody>
              </table>
              <button id="ad-more-tracks" class="btn ghost" style="display:none;">Show more</button>
            </div>

            <div id="ad-tab-audiobooks" class="ad-panel" style="display:none;">
              <table class="ad-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Plays</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="ad-ab"></tbody>
              </table>
              <button id="ad-more-ab" class="btn ghost" style="display:none;">Show more</button>
            </div>

            <div id="ad-tab-podcasts" class="ad-panel" style="display:none;">
              <table class="ad-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Host</th>
                    <th>Plays</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="ad-pc"></tbody>
              </table>
              <button id="ad-more-pc" class="btn ghost" style="display:none;">Show more</button>
            </div>
          </div>
        </div>
      </div>
      <div class="pagination" id="artists-pagination"></div>
    </div>
  </div>

  <!-- =================== ARTIST CREATE MODAL =================== -->
  <div id="artistCreateModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Artist</h2>
        <span class="close-btn" id="artist-create-close"></span>
      </div>

      <form id="artistCreateForm" enctype="multipart/form-data">
        <div class="form-input">
          <label>Name *</label>
          <input type="text" id="ar_name" name="name" required>
        </div>

        <div class="form-input">
          <label>Custom ID (optional)</label>
          <input type="text" id="ar_id" name="id" placeholder="Leave empty to auto-generate">
        </div>
        <div class="form-input">
          <label>Listeners</label>
          <input type="text" id="ar_listeners" name="listeners" placeholder="e.g. 1.2M">
        </div>
        <div class="form-textarea">
          <label>Description</label>
          <textarea id="ar_description" name="description" rows="5"></textarea>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Photo</label>
            <input type="file" id="ar_photo" name="photo" accept="image/*">
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" id="artist-create-cancel">Cancel</button>
          <button type="submit" class="save-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== ARTIST EDIT MODAL =================== -->
  <div id="artistEditModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Artist</h2>
        <span class="close-btn" id="artist-edit-close"></span>
      </div>

      <form id="artistEditForm" enctype="multipart/form-data">
        <input type="hidden" id="ar_e_id" name="id">

        <div class="form-row">
          <div class="form-input">
            <label>ID</label>
            <input type="text" id="ar_e_id_view" readonly>
          </div>
          <div class="form-input">
            <label>Name *</label>
            <input type="text" id="ar_e_name" name="name" required>
          </div>
        </div>

        <div class="form-textarea">
          <label>Description</label>
          <textarea id="ar_e_description" name="description" rows="5"></textarea>
        </div>
        <div class="form-input">
          <label>Listeners</label>
          <input type="text" id="ar_e_listeners" name="listeners" placeholder="e.g. 1.2M">
        </div>
        <div class="form-row">
          <div class="form-file-box">
            <label>Replace photo (optional)</label>
            <input type="file" id="ar_e_photo" name="photo" accept="image/*">
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" id="artist-edit-cancel">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== CUSTOMERS =================== -->
  <div id="customers-section" style="display:none;">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Customers</h2>
          <small>List of users</small>
        </div>
      </div>

      <div class="table-toolbar">
        <div class="table-filters">
          <div class="search-box">
            <img class="search-icon" src="/media/iconsLuniTune/Search.png" alt="">
            <input id="searchCustomerInput" type="text" placeholder="Search by ID, product, or others...">
          </div>

          <button class="btn" id="filtersBtnCustomers">
            <img class="ico" src="/media/iconsLuniTune/filter.png" alt="">
            Filters
          </button>

          <div id="customerFiltersPopover" class="filters-popover" hidden>
            <div class="popover-header">Filter Customers</div>
            <div class="popover-body">
              <label for="filterRole">Role</label>
              <select id="filterRole" name="role">
                <option value="">All</option>
                <option value="client">Client</option>
                <option value="staff">Staff</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="popover-footer">
              <button id="customerFiltersClear">Clear</button>
              <button id="customerFiltersApply">Apply</button>
            </div>
          </div>

          <button class="btn btn--primary" id="btn-open-create-customer">
            <img class="ico" src="/media/iconsLuniTune/u_plus.png" alt="">
            Add Customer
          </button>
        </div>
      </div>

      <div>
        <table class="tracks-table" id="customers-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all-customers"></th>
              <th>Customer name</th>
              <th>Email</th>
              <th>Title</th>
              <th>Table Title</th>
            </tr>
          </thead>
          <tbody id="customers-tbody"></tbody>
        </table>

        <div class="pagination" id="customers-pagination"></div>
      </div>
    </div>
  </div>

  <!-- =================== DASH OVERVIEW =================== -->
  <section id="dash-overview" style="display:none">
    <div class="top-title">
      <h2>Dashboard</h2>
      <small>Overview</small>
    </div>

    <div class="dash-controls">
      <button id="dashDateBtn" class="btn"><span>Last 7 days</span></button>
      <div id="dashDatePopover" class="popover" hidden>
        <div class="row">
          <label>Start</label><input type="date" id="dashDateStart" name="start">
        </div>
        <div class="row">
          <label>End</label><input type="date" id="dashDateEnd" name="end">
        </div>
        <div class="row gap">
          <button id="dashDateApply" class="btn primary">Apply</button>
          <button id="dashDateClear" class="btn">Clear</button>
          <button class="btn ghost" data-preset="7d">Last 7d</button>
          <button class="btn ghost" data-preset="30d">Last 30d</button>
        </div>
      </div>

      <div class="qa">
        <button class="btn ghost" id="qa-upload-track">+ Track</button>
        <button class="btn ghost" id="qa-new-ab">+ Audiobook</button>
        <button class="btn ghost" id="qa-new-pc">+ Podcast</button>
        <button class="btn ghost" id="qa-new-pl">+ Playlist</button>
      </div>
    </div>

    <div id="dash-kpis" class="kpi-grid"></div>

    <div class="dash-grid">
      <div class="card">
        <div class="card-head">
          <div class="title">Trends</div>
          <div class="tabs">
            <button class="tab active" data-obj="track">Tracks</button>
            <button class="tab" data-obj="audiobook">Audiobooks</button>
            <button class="tab" data-obj="podcast">Podcasts</button>
          </div>
          <div class="switch">
            <button class="chip active" data-metric="uploads">Uploads</button>
            <button class="chip" data-metric="plays">Plays</button>
          </div>
        </div>
        <div id="dash-line-wrap" class="line-wrap">
          <svg id="dash-line" viewBox="0 0 600 220" preserveAspectRatio="none"></svg>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="title">Top content</div>
          <div class="tabs">
            <button class="tab active" data-top="track">Tracks</button>
            <button class="tab" data-top="audiobook">Audiobooks</button>
            <button class="tab" data-top="podcast">Podcasts</button>
          </div>
        </div>
        <table class="table compact" id="dash-top-table">
          <thead><tr><th>Title</th><th>Meta</th><th>Plays</th><th>Time</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-head"><div class="title">Recent activity</div></div>
        <ul id="dash-recent" class="list slim"></ul>
      </div>

      <div class="card">
        <div class="card-head"><div class="title">Moderation queue</div></div>
        <div id="dash-moderation" class="queue"></div>
      </div>
    </div>
  </section>

  <!-- =================== PLAYLISTS =================== -->
  <div id="playlists-section" style="display:none;">
    <div class="tracks-container">
      <div class="tracks-top">
        <div class="top-title">
          <h2>Playlists</h2>
          <small>Your collections</small>
        </div>
      </div>
      <div class="pl-grid" id="playlists-grid"></div>
    </div>
  </div>

  <!-- =================== PLAYLIST CREATE MODAL =================== -->
  <div id="playlistCreateModal" class="modal" style="display:none;">
    <div class="modal-content pl-modal">
      <div class="modal-header">
        <h2>New Playlist</h2>
        <span class="close-btn" id="pl-close"></span>
      </div>

      <form id="playlistCreateForm" enctype="multipart/form-data">
        <div class="form-row">
          <div class="form-file-box">
            <label>Cover (optional)</label>
            <div class="pl-cover-uploader">
              <img id="pl-cover-preview" alt="">
              <input type="file" id="pl_cover" name="cover" accept="image/*">
            </div>
          </div>
          <div class="form-input">
            <label>Playlist title</label>
            <input type="text" id="pl_title" name="title" placeholder="My great playlist" required>
            <label style="margin-top:12px;">Description (optional)</label>
            <input type="text" id="pl_desc" name="description" placeholder="Short note">
          </div>
        </div>

        <div class="form-input">
          <label>Find tracks (by song or artist)</label>
          <input type="text" id="pl_track_search" placeholder="Type to search...">
        </div>

        <div class="pl-picker">
          <div class="pl-results">
            <div class="pl-results-head">Results</div>
            <ul id="pl_results_list"></ul>
          </div>

          <div class="pl-selected">
            <div class="pl-results-head">Selected <span id="pl_selected_count">0</span></div>
            <div id="pl_selected_chips" class="pl-chips"></div>
          </div>
        </div>

        <!-- важное: сюда твой JS будет писать JSON с выбранными треками -->
        <input type="hidden" id="pl_tracks_json" name="tracks_json" value="[]">

        <div class="form-buttons">
          <button type="button" class="reset-btn" id="pl-cancel">Cancel</button>
          <button type="submit" class="save-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== CUSTOMER MODALS =================== -->
  <div id="customerCreateModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Customer</h2>
        <span class="close-btn" onclick="closeCustomerCreateModal()"></span>
      </div>

      <form id="customerCreateForm">
        <div class="form-input">
          <label>Full name</label>
          <input type="text" id="c_full_name" name="full_name" placeholder="Jane Doe">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Email</label>
            <input type="text" id="c_email" name="email" required>
          </div>
          <div class="form-input">
            <label>Role</label>
            <select id="c_role" name="role">
              <option value="client">Client</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Password</label>
            <input type="text" id="c_password" name="password" required>
          </div>
          <div class="form-input">
            <label>Confirm</label>
            <input type="text" id="c_password2" name="password2" required>
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closeCustomerCreateModal()">Cancel</button>
          <button type="submit" class="save-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div id="customerEditModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Customer</h2>
        <span class="close-btn" onclick="closeCustomerEditModal()"></span>
      </div>

      <form id="customerEditForm">
        <input type="hidden" id="e_id" name="id">

        <div class="form-input">
          <label>Full name</label>
          <input type="text" id="e_full_name" name="full_name">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Email</label>
            <input type="text" id="e_email" name="email" required>
          </div>
          <div class="form-input">
            <label>Role</label>
            <select id="e_role" name="role">
              <option value="client">Client</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>New password (optional)</label>
            <input type="text" id="e_password" name="password">
          </div>
          <div class="form-input">
            <label>Confirm</label>
            <input type="text" id="e_password2" name="password2">
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closeCustomerEditModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== TRACK MODALS =================== -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Track</h2>
        <span class="close-btn" onclick="closeModal()"></span>
      </div>

      <form method="POST" action="{% url 'create_track' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-input">
          <label>Name Track</label>
          <input type="text" name="name" placeholder="Content" required>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>ID</label>
            <input type="text" name="track_id" placeholder="ID" required>
          </div>
          <div class="form-input">
            <label>ArtistId</label>
            <input type="text" name="artistid" placeholder="Artist ID" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>AlbumId</label>
            <input type="text" name="albumid" placeholder="Album ID">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>GenreId (Optional)</label>
            <input type="text" name="genreid" placeholder="Genre ID (Optional)">
          </div>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Import Track</label>
            <input type="file" name="track_file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Import Picture</label>
            <input type="file" name="cover_image" accept="image/*">
          </div>
        </div>

        <div class="form-textarea">
          <label>Info</label>
          <textarea name="info" placeholder="Placeholder content"></textarea>
        </div>

        <div class="form-buttons">
          <button type="reset" class="reset-btn">Reset</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Track Edit Modal ===== -->
  <div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Track</h2>
        <span class="close-btn" onclick="closeEditModal()"></span>
      </div>

      <form id="editTrackForm" enctype="multipart/form-data">
        <input type="hidden" id="edit_id" name="id">

        <div class="form-row">
          <div class="form-input">
            <label>ID</label>
            <input type="text" id="edit_id_view" readonly>
          </div>
          <div class="form-input">
            <label>Name</label>
            <input type="text" id="edit_name" name="name" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Artist</label>
            <input type="text" id="edit_artistid" name="artistid">
          </div>
          <div class="form-input">
            <label>Album</label>
            <input type="text" id="edit_albumid" name="albumid">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Genre</label>
            <input type="text" id="edit_genreid" name="genreid">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Info</label>
            <input type="text" id="edit_info" name="info">
          </div>
        </div>

        <!-- FIX: завернули в .form-file-box, чтобы появились рамки -->
        <div class="form-row">
          <div class="form-file-box">
            <label>Replace audio (optional)</label>
            <input type="file" id="edit_track_file" name="track_file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Cover image (optional)</label>
            <input type="file" id="edit_cover_image" name="cover_image" accept="image/*">
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== AUDIOBOOKS MODALS =================== -->
  <div id="audiobookCreateModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Audiobook</h2>
        <span class="close-btn" onclick="closeAudiobookCreateModal()"></span>
      </div>

      <form id="audiobookCreateForm" enctype="multipart/form-data">
        <div class="form-input">
          <label>Title</label>
          <input id="ab_title" name="title" type="text" autocomplete="off">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Author</label>
            <input id="ab_author" name="author" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>GenreId</label>
            <input id="ab_genreid" name="genreid" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Chapter</label>
            <input id="ab_chapter" name="chapter" type="text" autocomplete="off">
          </div>
          <div class="form-input"></div>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Audio</label>
            <input id="ab_audio" name="audio_file" type="file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Cover</label>
            <input id="ab_cover" name="cover_image" type="file" accept="image/*">
          </div>
        </div>

        <div class="form-textarea">
          <label>Info</label>
          <textarea id="ab_info" name="info" rows="6"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closeAudiobookCreateModal()">Cancel</button>
          <button type="submit" class="save-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div id="audiobookEditModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Audiobook</h2>
        <span class="close-btn" onclick="closeAudiobookEditModal()"></span>
      </div>

      <form id="audiobookEditForm" enctype="multipart/form-data">
        <input id="abe_id" name="id" type="hidden">

        <div class="form-input">
          <label>Title</label>
          <input id="abe_title" name="title" type="text" autocomplete="off">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Author</label>
            <input id="abe_author" name="author" type="text" autocomplete="off">
          </div>
          <div class="form-input">
            <label>Narrator</label>
            <input id="abe_narrator" name="narrator" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>GenreId</label>
            <input id="abe_genreid" name="genreid" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Chapter</label>
            <input id="abe_chapter" name="chapter" type="text" autocomplete="off">
          </div>
          <div class="form-input"></div>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Audio</label>
            <input id="abe_audio" name="audio_file" type="file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Cover</label>
            <input id="abe_cover" name="cover_image" type="file" accept="image/*">
          </div>
        </div>

        <div class="form-textarea">
          <label>Info</label>
          <textarea id="abe_info" name="info" rows="6"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closeAudiobookEditModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== PODCAST MODALS =================== -->
  <div id="podcastCreateModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h2>New Podcast</h2>
        <span class="close-btn" onclick="closePodcastCreateModal()"></span>
      </div>

      <form id="podcastCreateForm" enctype="multipart/form-data">
        <div class="form-input">
          <label>Title</label>
          <input id="pc_title" name="title" type="text" autocomplete="off">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Host</label>
            <input id="pc_host" name="host" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>GenreId</label>
            <input id="pc_genreid" name="genreid" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Episode</label>
            <input id="pc_episode" name="episode" type="text" autocomplete="off">
          </div>
          <div class="form-input"></div>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Audio</label>
            <input id="pc_audio" name="audio_file" type="file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Cover</label>
            <input id="pc_cover" name="cover_image" type="file" accept="image/*">
          </div>
        </div>

        <div class="form-textarea">
          <label>Info</label>
          <textarea id="pc_info" name="info" rows="6"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closePodcastCreateModal()">Cancel</button>
          <button type="submit" class="save-btn">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div id="podcastEditModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Podcast</h2>
        <span class="close-btn" onclick="closePodcastEditModal()"></span>
      </div>

      <form id="podcastEditForm" enctype="multipart/form-data">
        <input id="pce_id" name="id" type="hidden">

        <div class="form-input">
          <label>Title</label>
          <input id="pce_title" name="title" type="text" autocomplete="off">
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Host</label>
            <input id="pce_host" name="host" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>GenreId</label>
            <input id="pce_genreid" name="genreid" type="text" autocomplete="off">
          </div>
        </div>

        <div class="form-row">
          <div class="form-input">
            <label>Episode</label>
            <input id="pce_episode" name="episode" type="text" autocomplete="off">
          </div>
          <div class="form-input"></div>
        </div>

        <div class="form-row">
          <div class="form-file-box">
            <label>Audio</label>
            <input id="pce_audio" name="audio_file" type="file" accept="audio/*">
          </div>
          <div class="form-file-box">
            <label>Cover</label>
            <input id="pce_cover" name="cover_image" type="file" accept="image/*">
          </div>
        </div>

        <div class="form-textarea">
          <label>Info</label>
          <textarea id="pce_info" name="info" rows="6"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="reset-btn" onclick="closePodcastEditModal()">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* ====================== Global state ====================== */
let tracks = [];
let editingIndex = null;
const player = new Audio();
let currentIndex = null;

let dateRange = { start: null, end: null };
let searchQuery = "";
let filters = { artistid: null, albumid: null, genreid: null, tagsid: null, adult: null, has_audio: false };

let page = 1;
let perPage = 5;
let totalPages = 1;

// list panel (authors/albums/genres/tags)
let listPage = 1, listPerPage = 10, listTotalPages = 1;
let currentList = { field: null, value: "" };

/* ====================== Customers state ====================== */
let customers = [];
let custPage = 1;
let custPerPage = 7;
let custTotalPages = 1;
let custSearch = '';
let customerFilters = { role: "" };

/* ====================== Playlists state ====================== */
let playlists = [];
let selectedTracksMap = new Map();

/* ====================== Audiobooks & Podcasts state ====================== */
let audiobooks = [];
let abPage = 1, abPerPage = 7, abTotalPages = 1;
let abSearch = '';

let podcasts = [];
let pcPage = 1, pcPerPage = 7, pcTotalPages = 1;
let pcSearch = '';

/* ====================== DOM refs ====================== */
const dateBtn    = document.getElementById('dateRangeBtn');
const popover    = document.getElementById('datePopover');
const inputStart = document.getElementById('dateStart');
const inputEnd   = document.getElementById('dateEnd');

const searchInput = document.getElementById('searchInput');

const filtersBtn = document.getElementById('filtersBtn');
const filtersPopover = document.getElementById('filtersPopover');
const fArtist = document.getElementById('fArtist');
const fAlbum  = document.getElementById('fAlbum');
const fGenre  = document.getElementById('fGenre');
const fTags   = document.getElementById('fTags');
const fAdult  = document.getElementById('fAdult');
const fHasAudio = document.getElementById('fHasAudio');

const searchCustomerInput = document.getElementById('searchCustomerInput');
const btnOpenCreateCustomer = document.getElementById('btn-open-create-customer');
const filtersBtnCustomers = document.getElementById("filtersBtnCustomers");
const customerFiltersPopover = document.getElementById("customerFiltersPopover");
const filterRole = document.getElementById("filterRole");

// Playlists controls
const btnNewPlaylist = document.getElementById('btn-new-playlist') || document.querySelector('.new-item-btn');
const navPlaylists =
  document.getElementById('nav-playlists') ||
  Array.from(document.querySelectorAll('#elements .menu-item')).find(el => (el.textContent||'').trim().toLowerCase() === 'playlists');

const plModal      = document.getElementById('playlistCreateModal');
const plClose      = document.getElementById('pl-close');
const plCancel     = document.getElementById('pl-cancel');
const plForm       = document.getElementById('playlistCreateForm');

const plTitle      = document.getElementById('pl_title');
const plDesc       = document.getElementById('pl_desc');
const plCover      = document.getElementById('pl_cover');
const plCoverPrev  = document.getElementById('pl-cover-preview');
const plSearch     = document.getElementById('pl_track_search');
const plResults    = document.getElementById('pl_results_list');
const plChips      = document.getElementById('pl_selected_chips');
const plSelCount   = document.getElementById('pl_selected_count');

const playlistsGrid = document.getElementById('playlists-grid');
const LS_PLAYLISTS_KEY = 'dash.playlists';

/* Audiobooks/Podcasts refs */
const searchAudiobookInput = document.getElementById('searchAudiobookInput');
const searchPodcastInput   = document.getElementById('searchPodcastInput');
const btnOpenCreateAudiobook = document.getElementById('btn-open-create-audiobook');
const btnOpenCreatePodcast   = document.getElementById('btn-open-create-podcast');

let dashDate = {start: null, end:null} 
let dashObj = 'track'; 
let dashMetric = 'uploads'; 
let dashTop = 'track'; 

const navDashboard  = document.getElementById('nav-dashboard');
const dashDateBtn =  document.getElementById('dashDateBtn'); 
const dashDatePopover = document.getElementById('dashDatePopover');
const dashDateStart   = document.getElementById('dashDateStart');
const dashDateEnd = document.getElementById('dashDateEnd'); 
const dashDateApply = document.getElementById('dashDateApply'); 
const dashDateClear = document.getElementById('dashDateClear'); 

const kpiWrap = document.getElementById('dash-kpis'); 
const lineSvg = document.getElementById('dash-line');
const topTableBody = document.querySelector('#dash-top-table tbody');
const recentList = document.getElementById('dash-recent'); 
const moderationBox = document.getElementById('dash-moderation'); 

// Быстрые действия (дашборд): открываем модалки напрямую
document.getElementById('qa-upload-track')
  ?.addEventListener('click', () => { openModal?.(); });

document.getElementById('qa-new-ab')
  ?.addEventListener('click', () => { openAudiobookCreateModal?.(); });

document.getElementById('qa-new-pc')
  ?.addEventListener('click', () => { openPodcastCreateModal?.(); });

document.getElementById('qa-new-pl')
  ?.addEventListener('click', () => { openPlaylistCreateModal?.(); });
/* ====================== Dashboard Helpers ====================== */
function dashFormatBtn(){
  const span = dashDateBtn?.querySelector('span'); 
  const {start,end} = dashDate; 
  if(start || end){ 
    span && (span.textContent = `${start || '...'} - ${end || '...'}`);
    dashDateBtn?.classList.add('active') ;
  }else{ 
    span && (span.textContent = 'Last 7 days'); 
    dashDateBtn?.classList.remove('active');
  }
}
function renderLine(svg, points){
  if(!svg) return;
  svg.innerHTML = '';
  const W = 600, H = 200, pad = 18;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  if(!points || !points.length){
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', String(W/2));
    t.setAttribute('y', String(H/2));
    t.setAttribute('text-anchor', 'middle');
    t.setAttribute('fill', '#999');
    t.textContent = 'No data';
    svg.appendChild(t);
    return;
  }

  const xs = points.map((_, i) => i);
  const ys = points.map(p => Number(p.value) || 0);
  const n = points.length - 1;
  const minY = 0;
  const maxY = Math.max(1, ...ys);

  const scaleX = (i) => pad + (i * (W - 2*pad) / Math.max(1, n));
  const scaleY = (v) => H - pad - ((v - minY) / (maxY - minY)) * (H - 2*pad);

  // grid
  for (let g = 0; g <= 4; g++){
    const y = H - (pad + g * ((H - 2*pad)/4));
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', String(pad));
    line.setAttribute('x2', String(W - pad));
    line.setAttribute('y1', String(y));
    line.setAttribute('y2', String(y));
    line.setAttribute('stroke', '#eee');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);
  }

  // path
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  let d = '';
  xs.forEach((i, idx) => {
    const x = scaleX(i), y = scaleY(ys[i]);
    d += (idx === 0 ? `M${x} ${y}` : `L${x} ${y}`);
  });
  path.setAttribute('d', d);
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', '#111');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('stroke-linecap', 'round');
  svg.appendChild(path);

  // points
  xs.forEach(i => {
    const cx = scaleX(i), cy = scaleY(ys[i]);
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx', String(cx));
    c.setAttribute('cy', String(cy));
    c.setAttribute('r', '2.5');
    c.setAttribute('fill', '#111');
    svg.appendChild(c);
  });
}

function niceBytes(n){ 
  if(!n) return '0 B'; 
  const u = ['B', 'KB', 'MB', 'GB','TB']; let i = 0; 
  while(n>=1024 && i<u.length-1){n/=1024;i++;}
  return `${n.toFixed(i?1:0)} ${u[i]}`; 
}
/*===================DashboardRenders========================*/ 
function renderKPIs(k){ 
  if(!kpiWrap) return; 
  const items =[ 
    {label:'Tracks (total)', value:k.tracks_total, sub:`+${k.tracks_new||0} in range`},
    {label:'Audiobooks (total)', value:k.audiobooks_total, sub:`+${k.audiobooks_new||0}`},
    {label:'Podcasts (total)', value:k.podcasts_total, sub:`+${k.podcasts_new||0}`},
    {label:'Plays (overall)', value:k.plays_total},
    {label:'New users', value:k.new_users},
    {label:'Storage used', value:niceBytes(k.storage_bytes)}
  ];
  kpiWrap.innerHTML = items.map(x=>(
    `
    <div class="kpi">
      <div class="label">${x.label}</div>
      <div class="value">${x.value ?? 0}</div>
      ${x.sub ? `<div class = "sub">${x.sub}</div>`: ''}
    </div>`
  )).join('');
}
/* ====================== Dashboard: find audio for Top table ====================== */
async function fetchAudioSrcForTop(row){
  try{
    const rid = row.id || row.track_id || row.pk;
    if (rid){
      const r = await fetch(`/api/get_tracks/?q=${encodeURIComponent(rid)}&page=1&page_size=1&wrap=1`);
      const d = await r.json();
      const t = (d?.tracks || d?.items || (Array.isArray(d)? d : []))[0];
      if (t) return t.audio_url || t.stream_url || '';
    }
  }catch(_){}

  try{
    const title = (row.name || row.title || '').trim();
    const meta  = (row.artist || row.author || row.show || '').trim();
    const q     = [title, meta].filter(Boolean).join(' ');
    if (!q) return '';
    const r  = await fetch('/api/get_tracks/?page=1&page_size=5&wrap=1&q=' + encodeURIComponent(q));
    const d  = await r.json();
    const ls = d?.tracks || d?.items || (Array.isArray(d)? d : []);
    if (!ls.length) return '';
    const tn  = title.toLowerCase();
    const hit = ls.find(t => String(t.name||'').trim().toLowerCase() === tn) || ls[0];
    return hit ? (hit.audio_url || hit.stream_url || '') : '';
  }catch(_){}

  return '';
}

const TOP_SRC_CACHE = new Map(); 
const TOP_SRC_MISS = new Map(); 
const TOP_SRC_TTL_MS = 5 * 60 * 1000;

function topSrcKey(row){
  return String(row?.id ?? `title::${row?.name||''}`);
}
async function  getTopAudioSrc(row) {
  const key = topSrcKey(row); 
  const now = Date.now(); 
  if(TOP_SRC_CACHE.has(key)) return TOP_SRC_CACHE.get(key); 

  const missAt = TOP_SRC_MISS.get(key); 
  if (missAt && (now - missAt) < TOP_SRC_TTL_MS) return '';

  let src = row.audio_url || row.stream_url || ''; 
  if(!src){
    try{src = await fetchAudioSrcForTop(row); } catch(_){}
  }
  if(src) TOP_SRC_CACHE.set(key,src); 
  else TOP_SRC_MISS.set(key,now);

  return src || '';
} 
function pLimit(limit=3){
  let active = 0;
  const queue = []; 
  const next = () =>{
    if(active >=limit || queue.length ===0) return;
    active ++; 
    const {fn,resolve, reject} = queue.shift(); 
    fn().then(resolve,reject).finally(()=>{active--; next(); }); 
  };
  return (fn) => new Promise((resolve, reject) => {
    queue.push({fn, resolve, reject}); 
    next(); 
  })
}
const scheduleTopProbe = pLimit(3); 

function renderTop(list){
  if (!topTableBody) return;
  topTableBody.innerHTML = '';

  (list || []).forEach((row, idx) => {
    const meta =  dashTop === 'track'     ? (row.artist || '')
                : dashTop === 'audiobook' ? (row.author || '')
                :                            (row.show   || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.name || ''}</td>
      <td>${meta || ''}</td>
      <td>${row.plays || 0}</td>
      <td class="col-time">${row.time || '0:00'}</td>
    `;
    topTableBody.appendChild(tr);

    // Нужно ли пробовать длительность?
    const needProbe = (!row.time || row.time === '0:00');
    if (!needProbe) return;

    // Не спамим: ограничим глубокие списки
    if (idx > 24) return;

    const cell = tr.querySelector('.col-time');

    // Лимитируем параллельность и кэшируем src
    scheduleTopProbe(async () => {
      const src = await getTopAudioSrc(row);
      if (!src) return;                // промах кэша или нет файла
      await ensureTrackDuration({ id: row.id, time: row.time }, src, cell);
    });
  });
}

function fmtRecentDate(s){
  if(!s) return ''; 
  const canon = String(s).replace(' ', 'T').replace('+00:00','Z'); 
  const d = new Date(canon); 

  if(isNaN(d)){
     return String(s).split('.')[0].replace('T',' ').slice(0,16); 
  }
  const pad = n => String(n).padStart(2,'0'); 
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function renderRecent(list){
  if(!recentList) return; 
  recentList.innerHTML =''; 
  (list||[]).forEach(it=>{ 
    const meta = it.type==='track'? 'Track': (it.type==='audiobook' ? 'AudioBook' : 'Podcast');
    const li = document.createElement('li'); 
    li.innerHTML = `<span>${meta}</span><span class="truncate">${it.title||''}</span><span class="muted">${fmtRecentDate(it.at)}</span>`;
    recentList.appendChild(li); 
  })
}
function renderModeration(q){
  if(!moderationBox) return;
  const m = q || {};
  moderationBox.innerHTML = `
    <div class="q">
      <div class="ttl">Adult flagged (all)</div>
      <div class="num">${m.adult_flagged ?? 0}</div>
    </div>
    <div class="q">
      <div class="ttl">Missing duration • Tracks</div>
      <div class="num">${m.missing_duration?.tracks ?? 0}</div>
    </div>
    <div class="q">
      <div class="ttl">Missing duration • Audiobooks</div>
      <div class="num">${m.missing_duration?.audiobooks ?? 0}</div>
    </div>
    <div class="q">
      <div class="ttl">Missing duration • Podcasts</div>
      <div class="num">${m.missing_duration?.podcasts ?? 0}</div>
    </div>
    <div class="q">
      <div class="ttl">Missing audio files (AB+PC)</div>
      <div class="num">${m.missing_audio_count ?? 0}</div>
    </div>
  `;
}

/* ====================== Dashboard: API ====================== */
const DASH_API = '/api/dashboard';

function dashParams() {
  const p = new URLSearchParams();
  if (dashDate?.start) p.set('start', dashDate.start);
  if (dashDate?.end)   p.set('end',   dashDate.end);
  const q = p.toString();
  return q ? `?${q}` : '';
}


async function fetchJSON(url, opts = {}) {
  const res = await fetch(url, {
    credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
    ...opts
  });
  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error(`HTTP ${res.status} at ${url}: ${text.slice(0,300)}`);
  }
  return res.json();
}

async function loadDashboard() {
  const qp = dashParams();                // "?start=...&end=..."
  const extra = qp ? qp.replace('?', '&') : '';

  await Promise.all([
    // KPI
    fetchJSON(`${DASH_API}/summary/${qp}`)
      .then(d => renderKPIs(d.kpi || {})),

    // Trends
    fetchJSON(`${DASH_API}/timeseries/?metric=${encodeURIComponent(dashMetric)}&object=${encodeURIComponent(dashObj)}${extra}`)
      .then(d => renderLine(lineSvg, d.series || [])),

    // Top
    fetchJSON(`${DASH_API}/top/?object=${encodeURIComponent(dashTop)}&limit=10${extra}`)
      .then(d => renderTop(d.items || [])),

    // Recent
    fetchJSON(`${DASH_API}/recent/`)
      .then(d => renderRecent(d.items || [])),

    // Moderation
    fetchJSON(`${DASH_API}/moderation/`)
      .then(d => renderModeration(d.queues || {})),
  ]).catch(console.error);
}

/* ====================== Dashboard: UI wiring ====================== */
function showDashboardSection(){
  // спрятать все остальные
  ['dashboard-section','customers-section','playlists-section','audiobooks-section','podcasts-section','moods-section']
    .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

  // показать дашборд
  const over = document.getElementById('dash-overview');
  if (over) over.style.display = 'block';

  // подпись сверху
  setListTitle?.('Dashboard','Overview','dash-overview');

  // пресет дат и загрузка данных
  if (!dashDate.start && !dashDate.end){
    const now = new Date();
    const end = now.toISOString().slice(0,10);
    const s7  = new Date(now.getTime()-6*86400000);
    dashDate = { start: s7.toISOString().slice(0,10), end };
    dashFormatBtn();
  }
  loadDashboard();
}

navDashboard?.addEventListener('click', (e)=>{ e.preventDefault(); if (location.hash.toLowerCase() !== '#dashboard') location.hash = '#dashboard'; });

dashDateBtn?.addEventListener('click', ()=>{
  if (!dashDatePopover) return;
  dashDateStart && (dashDateStart.value = dashDate.start || '');
  dashDateEnd && (dashDateEnd.value = dashDate.end || '');
  if (dashDatePopover.hidden){
    const r = dashDateBtn.getBoundingClientRect();
    dashDatePopover.style.left = (r.left)+'px';
    dashDatePopover.style.top  = (r.bottom+8)+'px';
    dashDatePopover.hidden = false;
  } else dashDatePopover.hidden = true;
});
document.addEventListener('click', (e)=>{
  if (!dashDatePopover || dashDatePopover.hidden) return;
  if (!dashDatePopover.contains(e.target) && !dashDateBtn?.contains(e.target)) dashDatePopover.hidden = true;
});
dashDateApply?.addEventListener('click', ()=>{
  const s = dashDateStart?.value || null;
  const e = dashDateEnd?.value || null;
  if (s && e && s>e) return alert('Start must be before End');
  dashDate = { start: s, end: e };
  dashFormatBtn(); dashDatePopover.hidden = true; loadDashboard();
});
dashDateClear?.addEventListener('click', ()=>{
  dashDate = { start:null, end:null };
  dashFormatBtn(); dashDatePopover.hidden = true; loadDashboard();
});
dashDatePopover?.querySelectorAll('[data-preset]').forEach(b=>{
  b.addEventListener('click', ()=>{
    const days = b.dataset.preset==='30d' ? 30 : 7;
    const now = new Date();
    const end = now.toISOString().slice(0,10);
    const s = new Date(now.getTime()-(days-1)*86400000);
    dashDate = { start: s.toISOString().slice(0,10), end };
    dashFormatBtn(); dashDatePopover.hidden = true; loadDashboard();
  });
});

// Табы trends
document.querySelectorAll('#dash-overview .card .tabs .tab[data-obj]').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('#dash-overview .tab[data-obj]').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    dashObj = t.dataset.obj;
    loadDashboard();
  });
});
document.querySelectorAll('#dash-overview .chip[data-metric]').forEach(c=>{
  c.addEventListener('click', ()=>{
    document.querySelectorAll('#dash-overview .chip[data-metric]').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    dashMetric = c.dataset.metric;
    loadDashboard();
  });
});

// Вкладки Top
document.querySelectorAll('#dash-overview .tab[data-top]').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('#dash-overview .tab[data-top]').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    dashTop = t.dataset.top;
    loadDashboard();
  });
});

/* ====================== Helpers ====================== */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function getCookie(name){
  let cookieValue=null;
  if(document.cookie && document.cookie!==''){
    const cookies=document.cookie.split(';');
    for(const raw of cookies){
      const cookie=raw.trim();
      if(cookie.substring(0,name.length+1)===(name+'=')){ cookieValue=decodeURIComponent(cookie.substring(name.length+1)); break; }
    }
  }
  return cookieValue;
}
function escapeHtml(s=''){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
}

/* ====== Track duration helpers (fallback) ====== */
const DURATION_LS_KEY = 'dash.trackDurations';
let durationCache = {};
try { durationCache = JSON.parse(localStorage.getItem(DURATION_LS_KEY) || '{}'); } catch(_) {}

function saveDurations(){
  try { localStorage.setItem(DURATION_LS_KEY, JSON.stringify(durationCache)); } catch(_) {}
}
function formatDuration(sec){
  if (!isFinite(sec) || sec <= 0) return '0:00';
  const s = String(Math.floor(sec % 60)).padStart(2, '0');
  const m = Math.floor(sec / 60);
  return `${m}:${s}`;
}
function probeDuration(src){
  return new Promise((resolve, reject)=>{
    if (!src) return reject('no src');
    const a = new Audio();
    a.preload = 'metadata';
    a.crossOrigin = 'anonymous';
    const cleanup = ()=>{ a.removeAttribute('src'); try{ a.load(); }catch(_){ } };
    a.addEventListener('loadedmetadata', ()=>{
      const d = a.duration;
      cleanup();
      if (isFinite(d) && d > 0) resolve(d);
      else reject('no finite duration');
    }, { once:true });
    a.addEventListener('error', ()=>{ cleanup(); reject('error'); }, { once:true });
    a.src = src;
  });
}
async function ensureTrackDuration(track, src, cell){
  if (!cell) return;
  const key = `${track.id}::${src||''}`;
  let dur = durationCache[key] ?? durationCache[String(track.id)];
  if (isFinite(dur) && dur > 0){ cell.textContent = formatDuration(dur); return; }
  if (track.time && track.time !== '0:00'){ cell.textContent = track.time; return; }
  try{
    const seconds = await probeDuration(src);
    durationCache[key] = seconds;
    durationCache[String(track.id)] = seconds;
    saveDurations();
    cell.textContent = formatDuration(seconds);
  }catch(_){ cell.textContent = '0:00'; }
}

/* ====================== Playlists: local storage ====================== */
// Если у тебя где-то НЕ объявлен selectedTracksMap – объяви:
window.selectedTracksMap = window.selectedTracksMap || new Map();


// Унификация полей с определением типа
// унифицируем любой медиа-элемент в {type,id,name,artistid}
function pluralEn(n, one, many){ return n === 1 ? one : many; }

function normMediaItem(raw, typeHint){
  const type = raw?.type || typeHint ||
               (raw?.chapter != null ? 'audiobook' :
                (raw?.host    != null ? 'podcast'   : 'track'));
  return {
    type,
    id: String(raw?.id ?? raw?.track_id ?? raw?.pk ?? ''),
    name: raw?.name ?? raw?.title ?? '',
    artistid: raw?.artistid ?? raw?.artist ?? raw?.author ?? raw?.host ?? ''
  };
}
function mediaKey(it){ return `${it.type}:${it.id}`; }

function migrateSelectedMapKeys(){
  const fixes = [];
  selectedTracksMap.forEach((v,k)=>{ if(!k.includes(':')) fixes.push([k,v]); });
  fixes.forEach(([old,item])=>{
    const it = normMediaItem(item);
    selectedTracksMap.delete(old);
    selectedTracksMap.set(mediaKey(it), it);
  });
}



// Миграция старого формата ключей (если раньше ключом был просто id)
function migrateSelectedMapKeys(){
  const entries = Array.from(selectedTracksMap.entries());
  let changed = false;
  entries.forEach(([k,v])=>{
    if (!k.includes(':')){ // старый ключ без типа
      selectedTracksMap.delete(k);
      selectedTracksMap.set(mediaKey({ id:k, type:(v?.type||'track') }), { ...v, type:(v?.type||'track') });
      changed = true;
    }
  });
  return changed;
}

// Гарантируем, что инпут поиска реально подвязан (и в New, и в Edit)
function ensurePlaylistSearchBinding(){
  if (!plSearch) return;
  if (plSearch.dataset.bound === '1') return;  // защита от двойной подписки
  plSearch.addEventListener('input', searchTracksDebounced);
  plSearch.dataset.bound = '1';
}


function normalizePlaylist(p){
  // пытаемся вытащить "общий" счётчик если есть
  const genericCount =
      Number(p?.items_count ?? p?.total_items ?? p?.entries_count ?? p?.count ?? NaN);

  // сумма по типам, если бек отдаёт по отдельности
  const summed =
      ['tracks_count','audiobooks_count','podcasts_count']
        .reduce((s,k)=> s + (Number(p?.[k])||0), 0);

  // длина вложенного массива, если он пришёл
  const arrayLen =
      Array.isArray(p?.items)      ? p.items.length :
      Array.isArray(p?.tracks)     ? p.tracks.length :
      Array.isArray(p?.track_list) ? p.track_list.length : 0;

  const count =
      Number.isFinite(genericCount) ? genericCount :
      (summed > 0 ? summed : arrayLen);

  return {
    id: String(p?.id ?? p?.pk ?? ''),
    title: p?.title ?? p?.name ?? '',
    cover_url: p?.cover_url ?? p?.cover ?? p?.cover_image_url ?? '',
    // сохраняем что пришло — может пригодиться при открытии
    tracks: Array.isArray(p?.items) ? p.items
          : Array.isArray(p?.tracks) ? p.tracks
          : Array.isArray(p?.track_list) ? p.track_list
          : [],
    items_count: Number(count)||0        // <-- универсальный счётчик
  };
}


function savePlaylistsToStorage(){
  try{ localStorage.setItem(LS_PLAYLISTS_KEY, JSON.stringify(playlists)); }catch(_){}
}
function loadPlaylistsFromStorage(){
  try{
    const raw = localStorage.getItem(LS_PLAYLISTS_KEY);
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) playlists = arr;
    }
  }catch(_){}
}
/* ====================== Playlists: list from server ====================== */
async function loadPlaylistsFromServer(){
  try{
    const res = await fetch('/api/playlists/?wrap=1&with_counts=1');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const items = data.items || data.playlists || data.data || (Array.isArray(data)? data : []);
    playlists = items.map(normalizePlaylist).map(p => {
      const cached = getPlItems(p.id);
      if ((!p.tracks || !p.tracks.length) && cached.length) p.tracks = cached;
      p.items_count = Number(
        p.items_count ?? p.count ?? p.tracks_count ?? 0
      ) || (Array.isArray(p.tracks) ? p.tracks.length : 0);
      return p;
    });

    savePlaylistsToStorage();
    renderPlaylistsGrid();
  }catch(err){
    loadPlaylistsFromStorage();
    renderPlaylistsGrid();
  }
}


/* ====================== Sections ====================== */
function showTracksSection(){
  // прятать дашборд
  const over = document.getElementById('dash-overview');
  if (over) over.style.display = 'none';
  hideDashOverview()
  hideAllSections()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'block';
  if (c) c.style.display = 'none';
  if (p) p.style.display = 'none';
  if (ab) ab.style.display = 'none';
  if (pc) pc.style.display = 'none';

  hideListPanel();
  setListTitle('Tracks', 'All tracks', 'dashboard-section');
  if (!window._tracksLoadedOnce) { window._tracksLoadedOnce = true; loadTracksFromServer(); }
}
function showCustomersSection() {
  hideDashOverview()
  hideAllSections()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'none';
  if (c) c.style.display = 'block';
  if (p) p.style.display = 'none';
  if (ab) ab.style.display = 'none';
  if (pc) pc.style.display = 'none';

  if (!window._customersLoadedOnce) { window._customersLoadedOnce = true; loadCustomersFromServer(); }
}
function showPlaylistsSection(){
  hideDashOverview()
  hideAllSections()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'none';
  if (c) c.style.display = 'none';
  if (ab) ab.style.display = 'none';
  if (pc) pc.style.display = 'none';
  if (p) p.style.display = 'block';

  loadPlaylistsFromStorage();
  renderPlaylistsGrid();
  if (!window._plLoadedOnce) { window._plLoadedOnce = true; loadPlaylistsFromServer(); }
}
function showAudiobooksSection(){
  hideDashOverview()
  hideAllSections()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'none';
  if (c) c.style.display = 'none';
  if (p) p.style.display = 'none';
  if (pc) pc.style.display = 'none';
  if (ab) ab.style.display = 'block';

  document.querySelectorAll('#elements .menu-item[data-by]').forEach(x=>x.classList.remove('active'));
  setListTitle('Audiobooks', 'List of audiobooks', 'audiobooks-section');
  if (!window._abLoadedOnce){ window._abLoadedOnce = true; loadAudiobooksFromServer(); }
}
function showPodcastsSection(){
  hideDashOverview()
  hideAllSections()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'none';
  if (c) c.style.display = 'none';
  if (p) p.style.display = 'none';
  if (ab) ab.style.display = 'none';
  if (pc) pc.style.display = 'block';

  document.querySelectorAll('#elements .menu-item[data-by]').forEach(x=>x.classList.remove('active'));
  setListTitle('Podcasts', 'List of episodes', 'podcasts-section');
  if (!window._pcLoadedOnce){ window._pcLoadedOnce = true; loadPodcastsFromServer(); }
}

/* ====================== Date range ====================== */
function formatBtnRange(){
  const span = document.querySelector('#dateRangeBtn span');
  const btn = document.getElementById('dateRangeBtn');
  const active = (dateRange.start || dateRange.end);
  if(active){
    const s = dateRange.start ?? '…';
    const e = dateRange.end ?? '…';
    span && (span.textContent = `${s} - ${e}`);
    btn && btn.classList.add('active');
  }else{
    span && (span.textContent = 'All time');
    btn && btn.classList.remove('active');
  }
}
dateBtn?.addEventListener('click', () => {
  if (!popover) return;
  if (inputStart) inputStart.value = dateRange.start || '';
  if (inputEnd)   inputEnd.value   = dateRange.end   || '';
  popover.style.display = (popover.style.display === 'none' || !popover.style.display) ? 'block' : 'none';
});
document.addEventListener('click', (e) => { if (popover && !popover.contains(e.target) && !dateBtn?.contains(e.target)) popover.style.display = 'none'; });
document.getElementById('dateApply')?.addEventListener('click', () => {
  const s = inputStart?.value || null;
  const e = inputEnd?.value   || null;
  if (s && e && s > e) { alert('Start date must be before End date'); return; }
  dateRange = { start: s, end: e };
  formatBtnRange();
  page = 1;
  if (popover) popover.style.display = 'none';
  loadTracksFromServer();
});
document.getElementById('dateClear')?.addEventListener('click', () => {
  if (inputStart) inputStart.value = '';
  if (inputEnd)   inputEnd.value = '';
  dateRange = { start: null, end: null };
  formatBtnRange();
  page = 1;
  if (popover) popover.style.display = 'none';
  loadTracksFromServer();
});

/* ====================== Filters popover (tracks) ====================== */
function updateFiltersBtnState(){
  const active = !!(filters.artistid || filters.albumid || filters.genreid || filters.tagsid || filters.adult != null || filters.has_audio);
  filtersBtn?.classList.toggle('active', active);
}
function openFiltersPopover(){
  if (!filtersPopover || !filtersBtn) return;
  fArtist && (fArtist.value = filters.artistid || '');
  fAlbum  && (fAlbum.value  = filters.albumid  || '');
  fGenre  && (fGenre.value  = filters.genreid  || '');
  fTags   && (fTags.value   = filters.tagsid   || '');
  fAdult  && (fAdult.value  = (filters.adult===null ? '' : String(filters.adult)));
  fHasAudio && (fHasAudio.checked = !!filters.has_audio);

  if (filtersPopover.parentElement !== document.body) document.body.appendChild(filtersPopover);
  filtersPopover.hidden = false;

  const btnRect = filtersBtn.getBoundingClientRect();
  let left = btnRect.left;
  let top  = btnRect.bottom + 8;

  const pw = filtersPopover.offsetWidth || 360;
  const margin = 8;
  if (left + pw + margin > window.innerWidth) left = Math.max(margin, window.innerWidth - pw - margin);

  const ph = filtersPopover.offsetHeight || 320;
  if (top + ph + margin > window.innerHeight) top = Math.max(margin, btnRect.top - ph - 8);

  filtersPopover.style.left = `${left}px`;
  filtersPopover.style.top  = `${top}px`;
}
filtersBtn?.addEventListener('click', () => filtersPopover ? (filtersPopover.hidden ? openFiltersPopover() : (filtersPopover.hidden = true)) : null);
document.addEventListener('click', (e)=>{ if(filtersPopover && !filtersPopover.hidden && !filtersPopover.contains(e.target) && !filtersBtn?.contains(e.target)) filtersPopover.hidden = true; });
window.addEventListener('resize', () => { if(filtersPopover && !filtersPopover.hidden) openFiltersPopover(); });

document.getElementById('filtersApply')?.addEventListener('click', ()=>{
  filters.artistid = (fArtist?.value || '').trim() || null;
  filters.albumid  = (fAlbum?.value  || '').trim() || null;
  filters.genreid  = (fGenre?.value  || '').trim() || null;
  filters.tagsid   = (fTags?.value   || '').trim() || null;
  const adultVal = fAdult?.value ?? '';
  filters.adult  = (adultVal==='' ? null : adultVal==='true');
  filters.has_audio = !!fHasAudio?.checked;
  page = 1;
  updateFiltersBtnState();
  if (filtersPopover) filtersPopover.hidden = true;
  loadTracksFromServer();
});
document.getElementById('filtersClear')?.addEventListener('click', ()=>{
  filters = { artistid:null, albumid:null, genreid:null, tagsid:null, adult:null, has_audio:false };
  updateFiltersBtnState();
  page = 1;
  if (filtersPopover) filtersPopover.hidden = true;
  loadTracksFromServer();
});
const PLAY_ICON  = '<img src="/media/iconsLuniTune/Group 132.png" width="16" height="16">';
const PAUSE_ICON = '<img src="/media/iconsLuniTune/pause.png" width="16" height="16">';
/* ====================== Audio buttons (общие) ====================== */
function refreshAllPlayButtons(){
  // треки
  document.querySelectorAll('.play-btn').forEach((b, idx) => {
    const active = currentIndex === idx && !player.paused && player.src;
    b.innerHTML = active ? PAUSE_ICON : PLAY_ICON;
  });
  // аудиокниги
  document.querySelectorAll('.ab-play-btn').forEach((b, idx) => {
    const active = abCurrentIndex === idx && !player.paused && player.src;
    b.innerHTML = active ? PAUSE_ICON : PLAY_ICON;
  });
  // подкасты
  document.querySelectorAll('.pc-play-btn').forEach((b, idx) => {
    const active = pcCurrentIndex === idx && !player.paused && player.src;
    b.innerHTML = active ? PAUSE_ICON : PLAY_ICON;
  });
}

player.preload = 'none';
player.addEventListener('ended', () => {
  currentIndex = null;
  abCurrentIndex = null;
  pcCurrentIndex = null;
  refreshAllPlayButtons();
});
player.addEventListener('play',  refreshAllPlayButtons);
player.addEventListener('pause', refreshAllPlayButtons);


/* ====================== Audio buttons (tracks list) ====================== */
function playTrack(i, btn){
  const src = btn.dataset.src;
  if (!src){ alert('У трека нет аудио файла'); return; }
  if (currentIndex === i && !player.paused){ player.pause(); return; }
  if (player.src !== src) player.src = src;
  player.play().then(() => {
    currentIndex = i;
    abCurrentIndex = null;
    pcCurrentIndex = null;
    refreshAllPlayButtons();
  }).catch(console.error);
}
/* ====================== Tracks: rendering ====================== */
function renderTracks(list){
  const tbody = document.getElementById('tracks-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  (list||[]).forEach((track, index) => {
    const src = (track.audio_url && track.audio_url.length ? track.audio_url : track.stream_url) || '';
    const timeLabel = track.time_label || (Number(track.time) ? formatDuration(Number(track.time)) : '0:00');

    const row = document.createElement('tr');
    const globalIndex = ((page - 1) * perPage) + index; 
    row.dataset.id = track.id;

    row.innerHTML = `
      <td><input type="checkbox" class="row-select" data-id="${track.id}"></td>
      <td class="track-name">${track.name}</td>
      <td>${track.artistid}</td>
      <td>${track.genreid||''}</td>
      <td>${track.albumid||''}</td>
      <td>${track.playsnum||'0'}</td>
      <td class="col-adult">
        <input type="checkbox" class="adult-toggle"
              ${track.adult ? 'checked' : ''} onchange="setAdult('${track.id}', this)">
      </td>
      <td class="col-id">${track.id}</td>
      <td class="col-time">${timeLabel}</td>
      <td>
        <button class="action-btn play-btn" data-src="${src}"
                onclick="playTrack(${index}, this)" title="Play/Pause">
          <img src="/media/iconsLuniTune/Group 132.png" width="16" height="16">
        </button>
      </td>
      <td>
       <button class="action-btn edit-btn" onclick="editTrackById('${track.id}')">
          <img src="/media/iconsLuniTune/edit.png" width="16" height="16">
        </button>
       <button type="button" class="action-btn delete-btn" onclick="deleteTrackById('${track.id}'); event.stopPropagation();">
          <img src="/media/iconsLuniTune/close.png" width="16" height="16">
        </button>
      </td>`;
    tbody.appendChild(row);

    const timeCell = row.querySelector('.col-time');
    if (timeCell && src && (!track.time && !track.time_label)) {
      ensureTrackDuration(track, src, timeCell);
    }
  });

  const selAll = document.getElementById('select-all');
  if (selAll) selAll.checked = false;

  refreshAllPlayButtons();
}

async function setAdult(id, el) {
  const value = el.checked;
  try {
    const fd = new FormData();
    fd.append('adult', value ? 'true' : 'false');

    const res = await fetch(`/api/update_track/${encodeURIComponent(id)}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: fd
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || ('HTTP ' + res.status));

    const idx = tracks.findIndex(t => String(t.id) === String(id));
    if (idx !== -1) tracks[idx].adult = value;
  } catch (err) {
    console.error('Adult update failed:', err);
    el.checked = !value;
  }
}

function openModal(){ document.getElementById('modal')?.style && (document.getElementById('modal').style.display='flex'); }
function closeModal(){ document.getElementById('modal')?.style && (document.getElementById('modal').style.display='none'); }

/* ====================== Tracks: API ====================== */
function loadTracksFromServer(){
  const params = new URLSearchParams();
  params.set('wrap','1');

  if (dateRange.start) params.set('start', dateRange.start);
  if (dateRange.end)   params.set('end',   dateRange.end);
  if (searchQuery)     params.set('q',     searchQuery);

  if (filters.artistid) params.set('artistid', filters.artistid);
  if (filters.albumid)  params.set('albumid',  filters.albumid);
  if (filters.genreid)  params.set('genreid',  filters.genreid);
  if (filters.tagsid)   params.set('tagsid',   filters.tagsid);
  if (filters.adult !== null) params.set('adult', String(filters.adult));
  if (filters.has_audio) params.set('has_audio', 'true');

  params.set('page', page);
  params.set('page_size', perPage);

  const url = '/api/get_tracks/' + (params.toString() ? `?${params.toString()}` : '');

  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (!data?.success) { console.error('Error loading tracks:', data?.error); return; }

      tracks     = Array.isArray(data.tracks) ? data.tracks : [];
      perPage    = data.page_size || perPage;
      page       = data.page      || page;
      totalPages = Number(data.total_pages) || 1;

      renderTracks(tracks);
      renderPager('tracks-pagination', page, totalPages, (p) => { page = p; loadTracksFromServer(); }, true);
    })
    .catch(err => console.error('Error:', err));
}


async function deleteTrackById(id){
  if (!confirm('Delete this track?')) return;
  try{
    const res = await fetch(`/api/delete_track/${encodeURIComponent(id)}/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || ('HTTP ' + res.status));
    loadTracksFromServer();
  }catch(err){
    console.error(err);
    alert('Error deleting track: ' + err.message);
  }
}


/* ====================== Edit modal (track) ====================== */
function openTrackEditModal(t){
  const modal = document.getElementById('editModal') || document.getElementById('trackEditModal');
  if (!modal) { alert('Не найден id="editModal"'); return; }
  modal.style.display = 'flex';

  const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };

  // скрытый old id
  setVal('edit_id', t.id);

  // видимый редактируемый id
  const idView = document.getElementById('edit_id_view');
  if (idView){ idView.value = t.id; idView.disabled = false; idView.classList.remove('readonly'); }

  setVal('edit_name',     t.name);
  setVal('edit_artistid', t.artistid);
  setVal('edit_albumid',  t.albumid);
  setVal('edit_seqnum',   t.seqnum);
  setVal('edit_genreid',  t.genreid);
  setVal('edit_tagsid',   t.tagsid ?? t.tagid);
  setVal('edit_info',     t.info);

  // ВАЖНО: чекбокс adult
  const adultEl = document.getElementById('edit_adult');
  if (adultEl) adultEl.checked = !!t.adult;
}


function editTrackById(id){
  const t = tracks.find(x => String(x.id) === String(id));
  if (!t) { console.warn('track not found', id); return; }
  openTrackEditModal(t);
}

function editTrack(index){
  const t = tracks[index];
  if (!t) return console.warn('No track at', index);
  openTrackEditModal(t);
}
function closeEditModal(){
  const em = document.getElementById('editModal');
  if (em) em.style.display = 'none';
  document.getElementById('editTrackForm')?.reset();
  editingIndex = null;
}
/* ====================== Track Edit: submit ====================== */
document.getElementById('editTrackForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const oldId = (document.getElementById('edit_id').value || '').trim();
  const newId = (document.getElementById('edit_id_view')?.value || '').trim();

  const fd = new FormData();
  // текстовые поля
  fd.append('name',     (document.getElementById('edit_name')?.value || '').trim());
  fd.append('artistid', (document.getElementById('edit_artistid')?.value || '').trim());
  fd.append('albumid',  (document.getElementById('edit_albumid')?.value || '').trim());
  fd.append('genreid',  (document.getElementById('edit_genreid')?.value || '').trim());
  const tagsEl = document.getElementById('edit_tagsid');
  if (tagsEl) fd.append('tagsid', (tagsEl.value || '').trim());
  const infoEl = document.getElementById('edit_info');
  if (infoEl) fd.append('info', (infoEl.value || '').trim());
  const seqEl = document.getElementById('edit_seqnum');
  if (seqEl) fd.append('seqnum', (seqEl.value || '').trim());

  // adult чекбокс
  const adultEl = document.getElementById('edit_adult');
  if (adultEl) fd.append('adult', adultEl.checked ? 'true' : 'false');

  // смена ID
  if (newId && newId !== oldId) fd.append('new_id', newId);

  // файлы из EDIT формы
  const tf = document.getElementById('edit_track_file')?.files?.[0];
  const cf = document.getElementById('edit_cover_image')?.files?.[0];
  if (tf) fd.append('track_file', tf);
  if (cf) fd.append('cover_image', cf);

  try{
    const res = await fetch(`/api/update_track/${encodeURIComponent(oldId)}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: fd
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || res.status);

    await loadTracksFromServer();
    closeEditModal();
  }catch(err){
    console.error(err);
    alert('Error updating track: ' + err.message);
  }
});



/* ====================== List panel (authors/albums/genres/tags) ====================== */
const mainView = document.getElementById('main-view');
const listView = document.getElementById('list-view');
function showListPanel(){ if (mainView) mainView.hidden = true; if (listView) listView.hidden = false; }
function hideListPanel(){
  if (listView) listView.hidden = true;
  if (mainView){
    mainView.hidden = false;
    void mainView.offsetHeight; // рефлоу
  }
}
function setListTitle(main, sub, sectionId = 'dashboard-section'){
  const box = document.querySelector(`#${sectionId} .top-title`);
  if (!box) return;
  const h2 = box.querySelector('h2');
  const sm = box.querySelector('small');
  if (h2) h2.textContent = main;
  if (sm) sm.textContent = sub || '';
}

// Человечные названия + синонимы
const TITLE_MAP = { albumid:'Albums', genreid:'Genres', tagid:'Tags', artistid:'Authors', tracks:'Tracks' };
const FIELD_ALIASES = {
  genres:'genreid', genre:'genreid', geners:'genreid',
  tags:'tagsid', tag:'tagsid',
  authors:'artistid', artists:'artistid',
  albums:'albumid', album:'albumid',
  tracks:'tracks'
};
const normalizeField = (f) => FIELD_ALIASES[(f||'').toLowerCase()] || f;
const nice = (f)=>TITLE_MAP[f] || f;
const makeSub = (f,v)=> v ? `Filter: ${nice(f)} = ${v}` : `All ${nice(f)}`;

async function loadByField(field, value = "", q = ""){
  field = normalizeField(field);

  if (!field || field === 'tracks') {
    hideListPanel();
    setListTitle('Tracks', 'All tracks', 'dashboard-section');
    page = 1;
    if (typeof q === 'string') searchQuery = q.trim();
    loadTracksFromServer();
    return;
  }

  currentList = { field, value };
  const params = new URLSearchParams();
  if (q) params.set('q', q);
  params.set('page', listPage);
  params.set('page_size', listPerPage);

  const url = `/api/tracks/by/${encodeURIComponent(field)}/${value ? encodeURIComponent(value) + '/' : ''}`
            + (params.toString() ? `?${params.toString()}` : '');

  const res = await fetch(url);
  const data = await res.json();
  if (!res.ok || !data.success){ console.error(data.error || res.status); return; }

  setListTitle(nice(field), makeSub(field, value), 'dashboard-section');
  showListPanel();
  renderListTable(data.fields, data.items, data.field);

  listPerPage    = data.page_size || listPerPage;
  listPage       = data.page      || listPage;
  const total    = ('total' in data) ? data.total : (('count' in data) ? data.count : data.items.length);
  listTotalPages = data.total_pages || Math.max(1, Math.ceil(total / listPerPage));

  renderPager('lp-pagination', listPage, listTotalPages, (p)=>{ 
    listPage = p; 
    loadByField(currentList.field, currentList.value, (document.getElementById('searchInput')?.value||"").trim());
  });
}

function renderListTable(fields, items, groupField){
  const head = document.getElementById('lp-head');
  const body = document.getElementById('lp-body');
  if (!head || !body) return;

  head.innerHTML = `<th></th>` + fields.map(f => `<th>${f}</th>`).join('');
  body.innerHTML = (items||[]).map(row=>{
    const tds = fields.map(f=>{
      const v = row[f] ?? '';
      if (groupField && f === groupField && v){
        return `<td><a href="#" class="by-value" data-field="${groupField}" data-value="${v}">${v}</a></td>`;
      }
      return `<td>${v}</td>`;
    }).join('');
    return `<tr><td><input type="checkbox" class="track-checkbox"></td>${tds}</tr>`;
  }).join('');
  body.querySelectorAll('a.by-value').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      loadByField(a.dataset.field, a.dataset.value, (document.getElementById('searchInput')?.value||"").trim());
    });
  });
}

document.querySelectorAll('#elements .menu-item[data-by]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();

    const raw   = (a.dataset.by || '').toLowerCase();
    const field = normalizeField(raw);

    let targetHash = '#tracks';
    if (raw === 'playlists') targetHash = '#playlists';
    else if (raw === 'moods' && document.getElementById('moods-section')) targetHash = '#moods';
    else if (raw === 'audiobooks' && document.getElementById('audiobooks-section')) targetHash = '#audiobooks';
    else if (raw === 'podcasts' && document.getElementById('podcasts-section'))   targetHash = '#podcasts';

    if (location.hash.toLowerCase() !== targetHash) location.hash = targetHash;

    document.querySelectorAll('#elements .menu-item[data-by]').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');

    // если это НЕ "Tracks"-секция — выходим (логика секций у тебя уже есть)
    if (targetHash !== '#tracks') return;

    const q = (document.getElementById('searchInput')?.value || "").trim();
    listPage = 1;

    // НОВОЕ: агрегаторные таблицы
    if (raw === 'albums')  { loadAlbumsTable(q);  return; }
    if (raw === 'genres')  { loadGenresTable(q);  return; }

    // Остальное — по старому
    if (!field || field === 'tracks') {
      hideListPanel();
      setListTitle('Tracks', 'All tracks');
      page = 1; searchQuery = q; loadTracksFromServer();
      return;
    }
    loadByField(field, "", q);
  });
});


document.getElementById('nav-tracks')?.addEventListener('click', (e)=>{
  e.preventDefault();
  if (location.hash.toLowerCase() !== '#tracks') location.hash = '#tracks';
  document.querySelectorAll('#elements .menu-item[data-by]').forEach(x=>x.classList.remove('active'));
  hideListPanel();
  setListTitle('Tracks', 'All tracks', 'dashboard-section');
  page = 1;
  loadTracksFromServer();
});
document.getElementById('nav-playlists')?.addEventListener('click', (e)=>{
  e.preventDefault(); location.hash = '#playlists';
});
document.getElementById('nav-audiobooks')?.addEventListener('click', (e)=>{
  e.preventDefault(); location.hash = '#audiobooks';
});
document.getElementById('nav-podcasts')?.addEventListener('click', (e)=>{
  e.preventDefault(); location.hash = '#podcasts';
});

/* ====================== Tracks: search ====================== */
const runSearch = debounce(() => {
  page = 1;
  searchQuery = (searchInput?.value || "").trim();
  loadTracksFromServer();
}, 300);
searchInput?.addEventListener('input', runSearch);
searchInput?.addEventListener('keydown', (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault();
  const q = (searchInput?.value||"").trim();
  const active = document.querySelector('#elements .menu-item[data-by].active');
  if (!listView?.hidden && active){
    listPage = 1;
    loadByField(normalizeField(active.dataset.by), "", q);
  } else {
    page = 1;
    searchQuery = q;
    loadTracksFromServer();
  }
});

/* ====================== Pager generic ====================== */
function renderPager(containerId, current, total, onGoto, withBulkDelete = false) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const hasPages = total > 1;
  let html = '';

  if (hasPages) {
    const win = 5;
    let start = Math.max(1, current - Math.floor(win / 2));
    let end   = Math.min(total, start + win - 1);
    start     = Math.max(1, end - win + 1);

    const btn = (p, txt = p, disabled = false, active = false) =>
      `<button class="page-btn${active ? " active" : ""}" data-goto="${p}" ${disabled ? "disabled": ""}>${txt}</button>`;

    html += `<div class="page-numbers">`;
    html += btn(Math.max(1, current - 1), "◀", current === 1);

    if (start > 1) { html += btn(1, "1"); if (start > 2) html += `<button class="page-btn" disabled>…</button>`; }
    for (let p = start; p <= end; p++) html += btn(p, String(p), false, p === current);
    if (end < total) { if (end < total - 1) html += `<button class="page-btn" disabled>…</button>`; html += btn(total, String(total)); }

    html += btn(Math.min(total, current + 1), "▶", current === total);
    html += `</div>`;
  } else {
    html += `<div class="page-numbers"></div>`;
  }

  if (withBulkDelete) {
    html += `<button type="button" class="delete-selected-btn">Delete Selected</button>`;
  }

  el.innerHTML = html;
  el.style.display = (hasPages || withBulkDelete) ? 'flex' : 'none';

  if (hasPages) {
    el.querySelectorAll(".page-btn[data-goto]").forEach(b => {
      b.addEventListener("click", () => {
        const p = Number(b.dataset.goto);
        if (p && p !== current) onGoto(p);
      });
    });
  }

  const bulkBtn = el.querySelector(".delete-selected-btn");
  if (withBulkDelete && bulkBtn) {
    if (containerId === 'tracks-pagination')      bulkBtn.addEventListener('click', bulkDeleteSelected);
    if (containerId === 'customers-pagination')   bulkBtn.addEventListener('click', bulkDeleteCustomers);
    if (containerId === 'audiobooks-pagination')  bulkBtn.addEventListener('click', bulkDeleteAudiobooks);
    if (containerId === 'podcasts-pagination')    bulkBtn.addEventListener('click', bulkDeletePodcasts);
    if (containerId === 'artists-pagination')     bulkBtn.addEventListener('click', bulkDeleteArtists);   // ← НОВОЕ

  }
}

/* ====================== Tracks: bulk delete ====================== */
function getSelectedIds(){
  return Array.from(document.querySelectorAll('#tracks-tbody .row-select:checked'))
              .map(cb => cb.dataset.id || cb.closest('tr')?.dataset.id)
              .filter(Boolean);
}
async function bulkDeleteSelected(){
  const ids = getSelectedIds();
  if (!ids.length) return alert('Выберите хотя бы один трек.');
  if (!confirm(`Удалить выбранные (${ids.length})?`)) return;

  try{
    const res = await fetch('/api/bulk_delete_tracks/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json','X-CSRFToken': getCookie('csrftoken')},
      body: JSON.stringify({ ids })
    });
    const data = await res.json();
    if (!res.ok || !data.success) return alert('Error bulk delete: ' + (data.error || res.status));
    const selAll = document.getElementById('select-all');
    if (selAll) selAll.checked = false;
    loadTracksFromServer();
  }catch(e){
    console.error(e);
    alert('Network error while bulk deleting');
  }
}
document.getElementById('select-all')?.addEventListener('change', function(){
  document.querySelectorAll('#tracks-tbody .row-select').forEach(cb => cb.checked = this.checked);
});

/* ====================== Customers UI ====================== */
btnOpenCreateCustomer?.addEventListener('click', openCustomerCreateModal);
function openCustomerCreateModal(){ document.getElementById('customerCreateModal')?.style && (document.getElementById('customerCreateModal').style.display = 'flex'); }
function closeCustomerCreateModal(){ 
  const m = document.getElementById('customerCreateModal');
  if (m) m.style.display = 'none';
  document.getElementById('customerCreateForm')?.reset();
}
function openCustomerEditModal(){ document.getElementById('customerEditModal')?.style && (document.getElementById('customerEditModal').style.display = 'flex'); }
function closeCustomerEditModal(){ 
  const m = document.getElementById('customerEditModal');
  if (m) m.style.display = 'none';
  document.getElementById('customerEditForm')?.reset();
}
document.getElementById('select-all-customers')?.addEventListener('change', function(){
  document.querySelectorAll('#customers-tbody .row-select').forEach(cb=> cb.checked = this.checked);
});
function renderCustomers(list){
  const tbody = document.getElementById('customers-tbody');
  if (!tbody) return;

  let local = Array.isArray(list) ? list.slice() : customers.slice();

  if (custSearch) {
    const q = custSearch.toLowerCase();
    local = local.filter(c => 
      String(c.full_name || c.username || '').toLowerCase().includes(q) ||
      String(c.email || '').toLowerCase().includes(q)
    );
  }
  if (customerFilters.role) {
    const role = customerFilters.role.trim().toLowerCase();
    local = local.filter(c => String(c.role || '').trim().toLowerCase() === role);
  }

  tbody.innerHTML = '';
  local.forEach(u=>{
    const tr = document.createElement('tr');
    tr.dataset.id = u.id;
    tr.innerHTML = `
      <td><input type="checkbox" class="row-select" data-id="${u.id}"></td>
      <td>${(u.full_name || u.username || '').toString()}</td>
      <td>${u.email || ''}</td>
      <td>${(u.role||'').toString().replace(/^./, s=>s.toUpperCase())}</td>
      <td>
        <button class="action-btn" onclick="startEditCustomer('${u.id}')"><img src="/media/iconsLuniTune/edit.png" width="16" height="16"> Edit</button>
        <button class="action-btn delete-btn" onclick="deleteCustomer('${u.id}')"><img src="/media/iconsLuniTune/close.png" width="16" height="16"> Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function loadCustomersFromServer() {
  const params = new URLSearchParams({
    page: String(custPage),
    page_size: String(custPerPage),
  });
  if (custSearch) params.set('q', custSearch);
  if (customerFilters.role) params.set('role', customerFilters.role);

  const url = '/api/customers/?' + params.toString();
  console.log('[customers] GET', url);

  fetch(url, {
    method: 'GET',
    credentials: 'same-origin',
    headers: { 'Accept': 'application/json' }
  })
    .then(async (r) => {
      console.log('[customers] status', r.status, r.headers.get('content-type') || '');
      if (r.status === 401) {
        // не залогинен — уводим на логин и выходим
        window.location.href = '/api/auth/?next=/api/dashboard/#customers-section';
        throw new Error('Unauthorized');
      }
      return r.json();
    })
    .then((data) => {
      if (!data.success) throw new Error(data.error || 'Unknown error');
      customers = data.items || [];
      custPage = data.page ?? custPage;
      custPerPage = data.page_size ?? custPerPage;
      custTotalPages = data.total_pages ?? Math.max(1, Math.ceil((data.total || customers.length) / custPerPage));
      renderCustomers(customers);
      renderCustomersPager();
      const selAll = document.getElementById('select-all-customers');
      if (selAll) selAll.checked = false;
    })
    .catch((err) => console.error('Customers load failed:', err));
}
function renderCustomersPager() {
  if (typeof renderPager !== 'function') {
    // на всякий случай не падать, если общий pager ещё не загружен
    const p = document.getElementById('customers-pagination');
    if (p) p.innerHTML = '';
    return;
  }
  renderPager(
    'customers-pagination',
    custPage,
    custTotalPages,
    (p) => { custPage = p; loadCustomersFromServer(); },
    true
  );
}

// поиск оставляем как есть
const runCustSearch = debounce(() => {
  custPage = 1;
  custSearch = (searchCustomerInput?.value || '').trim();
  loadCustomersFromServer();
}, 300);

searchCustomerInput?.addEventListener('input', runCustSearch);

// Create / Edit / Delete customers
document.getElementById('customerCreateForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const full_name = document.getElementById('c_full_name').value.trim();
  const email = document.getElementById('c_email').value.trim();
  const role = document.getElementById('c_role').value;
  const p1 = document.getElementById('c_password').value;
  const p2 = document.getElementById('c_password2').value;
  if(p1 !== p2){ return alert('Passwords do not match'); }

  const fd = new FormData();
  fd.append('full_name', full_name);
  fd.append('email', email);
  fd.append('role', role);
  fd.append('password', p1);

  const res = await fetch('/api/customers/create/', {
    method: 'POST',
    headers: {'X-CSRFToken': getCookie('csrftoken')},
    body: fd
  });
  const data = await res.json();
  if(!res.ok || !data.success) return alert('Create error: ' + (data.error || res.status));
  closeCustomerCreateModal();
  custPage = 1;
  loadCustomersFromServer();
});
function roleFromFlags(u){ if(u.is_admin) return 'admin'; if(u.is_staff) return 'staff'; return 'client'; }
function startEditCustomer(id){
  const u = customers.find(x => String(x.id) === String(id));
  if(!u) return;
  document.getElementById('e_id').value = u.id;
  document.getElementById('e_full_name').value = u.full_name || u.username || '';
  document.getElementById('e_email').value = u.email || '';
  document.getElementById('e_role').value = u.role || roleFromFlags(u);
  document.getElementById('e_password').value = '';
  document.getElementById('e_password2').value = '';
  openCustomerEditModal();
}
document.getElementById('customerEditForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('e_id').value;
  const full_name = document.getElementById('e_full_name').value.trim();
  const email = document.getElementById('e_email').value.trim();
  const role = document.getElementById('e_role').value;
  const p1 = document.getElementById('e_password').value;
  const p2 = document.getElementById('e_password2').value;
  if(p1 || p2){ if(p1 !== p2) return alert('Passwords do not match'); }

  const fd = new FormData();
  fd.append('full_name', full_name);
  fd.append('email', email);
  fd.append('role', role);
  if (p1) fd.append('password', p1);

  try{
    const res = await fetch(`/api/customers/update/${encodeURIComponent(id)}/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken')},
      body: fd
    });
    const data = await res.json();
    if(!res.ok || !data.success) return alert('Update error: ' + (data.error || res.status));
    closeCustomerEditModal();
    loadCustomersFromServer();
  }catch(err){
    console.error(err);
    alert('Network error while updating customer');
  }
});

/* delete customer (single) */
async function deleteCustomer(id){
  if(!confirm('Delete this customer?')) return;
  try{
    const res = await fetch(`/api/customers/delete/${encodeURIComponent(id)}/`, {
      method: 'DELETE',
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await res.json();
    if(!res.ok || !data.success) return alert('Delete error: ' + (data.error || res.status));
    loadCustomersFromServer();
  }catch(err){
    console.error(err);
    alert('Network error while deleting customer');
  }
}
async function loadAgg(kind, q = "") {
  // kind: 'albums' | 'genres'
  const url = kind === 'albums' ? '/api/albums/' : '/api/genres/';
  const params = new URLSearchParams({ page: String(listPage), page_size: String(listPerPage) });
  if (q) params.set('q', q);

  const res = await fetch(url + '?' + params.toString());
  const data = await res.json();
  if (!res.ok || !data.success) { console.error(data.error || res.status); return; }

  const title = (kind === 'albums') ? 'Albums' : 'Genres';
  setListTitle(title, `All ${title.toLowerCase()}`, 'dashboard-section');
  showListPanel();
  // сервер должен вернуть: {success, field: 'albumid'|'genreid', fields: ['albumid','tracks_count'], items: [...]}
  renderListTable(data.fields, data.items, data.field);

  listPerPage    = data.page_size || listPerPage;
  listPage       = data.page      || listPage;
  const total    = ('total' in data) ? data.total : (('count' in data) ? data.count : data.items.length);
  listTotalPages = data.total_pages || Math.max(1, Math.ceil(total / listPerPage));

  renderPager('lp-pagination', listPage, listTotalPages, (p) => {
    listPage = p;
    loadAgg(kind, (document.getElementById('searchInput')?.value || "").trim());
  });
}

function loadAlbumsTable(q = "") { return loadAgg('albums', q); }
function loadGenresTable(q = "") { return loadAgg('genres', q); }

/* bulk delete customers */
async function bulkDeleteCustomers(){
  const ids = getSelectedCustomerIds();
  if(!ids.length) return alert('Выберите хотя бы одного пользователя.');
  if(!confirm(`Удалить выбранных (${ids.length})?`)) return;

  try{
    const res = await fetch('/api/customers/bulk_delete/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json','X-CSRFToken': getCookie('csrftoken')},
      body: JSON.stringify({ ids })
    });
    const data = await res.json();
    if(!res.ok || !data.success) return alert('Bulk delete error: ' + (data.error || res.status));
    loadCustomersFromServer();
  }catch(err){
    console.error(err);
    alert('Network error while bulk deleting customers');
  }
}

/* ====================== Playlists UI (clean) ====================== */
/* --- DOM refs / guards --- */

/* --- global state / guards --- */
window.playlists = window.playlists || [];

if (typeof debounce !== 'function'){
  // простой debounce на всякий случай
  window.debounce = (fn, wait=250) => {
    let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), wait); };
  };
}
function escapeHtml(s){
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return String(s).replace(/[&<>"']/g, ch => map[ch]);
}
const cssEscape = (window.CSS && CSS.escape) ? CSS.escape : (s)=>String(s).replace(/[^a-zA-Z0-9_\-]/g, m=>'\\'+m);

window.savePlaylistsToStorage = window.savePlaylistsToStorage || function(){
  try{ localStorage.setItem('dash.playlists', JSON.stringify(playlists)); }catch(_){}
};

/* ====================== Helpers ====================== */
// единый Map между открытиями модалки
window.selectedTracksMap = window.selectedTracksMap || new Map();

// ключ по типу и id, чтобы не было дублей между TR/AB/PC
function mediaKey(it){ return `${it.type}:${String(it.id)}`; }

// нормализуем любой тип медиа в общий вид
function normMediaItem(raw, typeHint){
  const t0 = (raw?.type || typeHint || '').toLowerCase();
  const type = (t0 === 'audiobook' || t0 === 'ab') ? 'audiobook'
             : (t0 === 'podcast'   || t0 === 'pc') ? 'podcast'
             : 'track';

  const id = String(
    raw?.id ?? raw?.track_id ?? raw?.pk ?? raw?.episode_id ?? raw?.audiobook_id ?? ''
  );
  if (!id) return null;

  const name     = raw?.name ?? raw?.title ?? '';
  const artistid = raw?.artistid ?? raw?.artist ?? raw?.author ?? raw?.host ?? '';
  return { type, id, name, artistid };
}

// миграция старых ключей без типа
function migrateSelectedMapKeys(){
  const todo = [];
  selectedTracksMap.forEach((v, k) => {
    if (!k.includes(':') && v?.type) todo.push([k, `${v.type}:${v.id}`, v]);
  });
  todo.forEach(([oldK, newK, val]) => {
    selectedTracksMap.delete(oldK);
    selectedTracksMap.set(newK, val);
  });
}

// plural
function pluralEn(n, one, many){ return n === 1 ? one : many; }

// idempotent-биндинг поиска в модалке
let _plSearchBound = false;
function ensurePlaylistSearchBinding(){
  if (_plSearchBound || !plSearch) return;
  plSearch.addEventListener('input', searchTracksDebounced);
  _plSearchBound = true;
}

/* ====================== Local cache of playlist items ====================== */
const LS_PL_ITEMS = 'dash.playlistItems';
let PL_ITEMS = {};
try { PL_ITEMS = JSON.parse(localStorage.getItem(LS_PL_ITEMS) || '{}'); } catch(_){}

function getPlItems(id){
  const arr = PL_ITEMS[String(id)];
  return Array.isArray(arr) ? arr : [];
}
function setPlItems(id, items){
  PL_ITEMS[String(id)] = items;
  try{ localStorage.setItem(LS_PL_ITEMS, JSON.stringify(PL_ITEMS)); }catch(_){}
}

/* ====================== Open/Close & Reset ====================== */
navPlaylists && navPlaylists.addEventListener('click', (e)=>{
  e.preventDefault();
  location.hash = '#playlists';
});
btnNewPlaylist && btnNewPlaylist.addEventListener('click', openPlaylistCreateModal);
plClose && plClose.addEventListener('click', closePlaylistCreateModal);
plCancel && plCancel.addEventListener('click', closePlaylistCreateModal);

function resetPlaylistForm(){
  plForm?.reset?.();
  if (plForm) delete plForm.dataset.editId;
  const btn = plForm?.querySelector('[type="submit"]');
  if (btn){ btn.textContent = 'Create playlist'; btn.classList.remove('saving-as-edit'); }

  selectedTracksMap.clear();
  if (plSelCount) plSelCount.textContent = '0';
  if (plChips) plChips.innerHTML = '';
  if (plResults) plResults.innerHTML = '';
  if (plCoverPrev){ plCoverPrev.src = ''; plCoverPrev.style.display = 'none'; }
}
function openPlaylistCreateModal(){
  resetPlaylistForm();
  ensurePlaylistSearchBinding();
  searchTracksDebounced(); // показать стартовые результаты
  if (plModal?.style) plModal.style.display = 'flex';
}
function closePlaylistCreateModal(){
  resetPlaylistForm();
  if (plModal?.style) plModal.style.display = 'none';
}
plCover && plCover.addEventListener('change', ()=>{
  const f = plCover.files?.[0];
  if(!f){
    if (plCoverPrev){ plCoverPrev.src=''; plCoverPrev.style.display='none'; }
    return;
  }
  const url = URL.createObjectURL(f);
  if (plCoverPrev){ plCoverPrev.src = url; plCoverPrev.style.display = 'block'; }
});

/* ====================== Playlist modal search (TR/AB/PC) ====================== */
const searchTracksDebounced = debounce(async ()=>{
  if (!plResults || !plSearch) return;
  const q = (plSearch.value || '').trim();

  const local = [];
  try{
    (Array.isArray(window.tracks)     ? window.tracks     : []).forEach(t => { const it = normMediaItem(t,'track');     if (it) local.push(it); });
    (Array.isArray(window.audiobooks) ? window.audiobooks : []).forEach(a => { const it = normMediaItem(a,'audiobook'); if (it) local.push(it); });
    (Array.isArray(window.podcasts)   ? window.podcasts   : []).forEach(p => { const it = normMediaItem(p,'podcast');   if (it) local.push(it); });
  }catch(_){}

  const filterLocal = (arr,q) => {
    if (!q) return arr.slice(0, 50);
    const ql = q.toLowerCase();
    return arr.filter(it=>{
      const n = (it.name||'').toLowerCase();
      const a = (it.artistid||'').toLowerCase();
      return n.includes(ql) || a.includes(ql);
    }).slice(0, 100);
  };

  let merged = filterLocal(local, q);

  try{
    const params = new URLSearchParams({ page:'1', page_size:'50' });
    if (q) params.set('q', q);

    const [rT, rA, rP] = await Promise.all([
      fetch('/api/get_tracks/?wrap=1&'   + params.toString()).then(r=>r.json()).catch(()=>null),
      fetch('/api/audiobooks/?wrap=1&'   + params.toString()).then(r=>r.json()).catch(()=>null),
      fetch('/api/podcasts/?wrap=1&'     + params.toString()).then(r=>r.json()).catch(()=>null),
    ]);

    const acc = new Map(merged.map(it => [mediaKey(it), it]));
    const add = (data, typeHint)=>{
      const list = Array.isArray(data) ? data : (data?.tracks || data?.items || data?.results || data?.data || []);
      list.forEach(raw => { const it = normMediaItem(raw, typeHint); if (it) acc.set(mediaKey(it), it); });
    };

    if (rT) add(rT, 'track');
    if (rA) add(rA, 'audiobook');
    if (rP) add(rP, 'podcast');

    merged = Array.from(acc.values()).slice(0, 150);
  }catch(_){}

  renderTrackResults(merged);
}, 250);

function renderTrackResults(list){
  if (!plResults) return;
  plResults.innerHTML = '';

  (list||[]).forEach(it=>{
    const key = mediaKey(it);
    const li = document.createElement('li');
    li.className = 'pl-row';
    li.innerHTML = `
      <div class="meta">
        <div class="name"   title="${escapeHtml(it.name||'')}">${it.name||''}</div>
        <div class="artist" title="${escapeHtml(it.artistid||'')}">
          <span class="pill">${it.type==='audiobook'?'AB':it.type==='podcast'?'PC':'TR'}</span>
          ${it.artistid||''}
        </div>
      </div>
      <button type="button">${selectedTracksMap.has(key) ? 'Added' : 'Add'}</button>
    `;
    li.querySelector('button').addEventListener('click', ()=>{
      if (selectedTracksMap.has(key)) return; // защита от дубля
      selectedTracksMap.set(key, it);         // сохраняем весь объект, включая type
      updateSelectedChips();
      li.querySelector('button').textContent = 'Added';
    });
    plResults.appendChild(li);
  });
}

function updateSelectedChips(){
  if (!plChips || !plSelCount) return;
  plChips.innerHTML = '';

  selectedTracksMap.forEach((t, key)=>{
    const chip = document.createElement('div');
    chip.className = 'pl-chip';
    chip.innerHTML = `
      <span class="truncate">
        <span class="pill">${t.type==='audiobook'?'AB':t.type==='podcast'?'PC':'TR'}</span>
        ${escapeHtml(t.name||'')} — ${escapeHtml(t.artistid||'')}
      </span>
      <span class="x" title="Remove">×</span>
    `;
    chip.querySelector('.x').addEventListener('click', ()=>{
      selectedTracksMap.delete(key);
      updateSelectedChips();
    });
    plChips.appendChild(chip);
  });

  plSelCount.textContent = String(selectedTracksMap.size);
}

/* ====================== Create / Edit ====================== */
if (plForm){
  plForm.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const title = (plTitle?.value || '').trim();
    if (!title) return alert('Enter playlist title');

    const itemsArr = Array.from(selectedTracksMap.values());
    const fd = new FormData();
    fd.append('title', title);
    fd.append('description', (plDesc?.value || '').trim());
    if (itemsArr.length) fd.append('tracks_json', JSON.stringify(itemsArr));
    if (plCover?.files?.[0]) fd.append('cover', plCover.files[0]);

    const editId = plForm.dataset?.editId || null;

    // оптимистично добавим/обновим локально
    let localId = null;
    if (!editId) {
      localId = 'pl_' + Date.now();
      playlists.unshift({
        id: localId,
        title,
        desc: (plDesc?.value || '').trim(),
        cover_url: plCoverPrev?.src || '',
        tracks: itemsArr,
        items_count: itemsArr.length
      });
      setPlItems(localId, itemsArr);
      renderPlaylistsGrid();
    }

    try{
      const url = editId
        ? `/api/playlists/update/${encodeURIComponent(editId)}/`
        : `/api/playlists/create/`;

      const res  = await fetch(url, { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || ('HTTP ' + res.status));

      if (editId) {
        const i = playlists.findIndex(p => String(p.id) === String(editId));
        if (i > -1) {
          playlists[i].title = title;
          if (data.cover_url) playlists[i].cover_url = data.cover_url;
          playlists[i].tracks = itemsArr;
          playlists[i].items_count = itemsArr.length;
          setPlItems(editId, itemsArr);
        }
      } else {
        const i = playlists.findIndex(p => p.id === localId);
        if (i > -1) {
          const newId = String(data.id || playlists[i].id);
          playlists[i].id = newId;
          if (data.cover_url) playlists[i].cover_url = data.cover_url;
          setPlItems(newId, itemsArr);
        }
      }

      savePlaylistsToStorage();
      renderPlaylistsGrid();
      closePlaylistCreateModal();
      delete plForm.dataset.editId;
      const btn = plForm.querySelector('[type="submit"]');
      btn && (btn.textContent = 'Create playlist');
      location.hash = '#playlists';
    }catch(err){
      console.error(err);
      if (!editId && localId) {
        playlists = playlists.filter(p => p.id !== localId);
        renderPlaylistsGrid();
      }
      alert(err.message || 'Network error');
    }
  });
}

/* ====================== Grid render & counts ====================== */
function playlistItemsCount(pl){
  const fromCache  = getPlItems(pl.id).length;               // локально сохранённый состав
  const fromArray  = Array.isArray(pl?.tracks) ? pl.tracks.length : 0; // когда массив уже есть в объекте
  const fromServer = Number(pl?.items_count ?? pl?.tracks_count ?? pl?.count ?? 0);
  return Math.max(fromCache, fromArray, fromServer, 0);
}


function renderPlaylistsGrid(){
  if (!playlistsGrid) return;
  playlistsGrid.innerHTML = '';

  (playlists || []).forEach(pl => {
    const cnt = playlistItemsCount(pl);
    const label = `${cnt} ${pluralEn(cnt,'item','items')}`;

    const div = document.createElement('div');
    div.className = 'pl-card';
    div.dataset.id = String(pl.id);
    div.innerHTML = `
      <img class="pl-cover" src="${pl.cover_url || '/media/placeholder-cover.png'}" alt="">
      <div class="pl-actions">
        <button class="pl-action pl-edit" title="Edit"><img src="/media/iconsLuniTune/edit.png" alt=""></button>
        <button class="pl-action pl-del"  title="Delete"><img src="/media/iconsLuniTune/close.png" alt=""></button>
      </div>
      <div class="pl-title" title="${escapeHtml(pl.title)}">${pl.title}</div>
      <div class="pl-sub">${cnt} ${pluralEn(cnt,'item','items')}</div>
    `;
    playlistsGrid.appendChild(div);
  });

  // лениво досчитываем, если карточка показывает 0 и мы не знаем массив
  (playlists || []).forEach(async (pl, idx) => {
    if (playlistItemsCount(pl) > 0) return;
    const items = await fetchPlaylistTracks(pl.id);
    const cnt = items.length;
    const sub = playlistsGrid.querySelector(`.pl-card[data-id="${cssEscape(String(pl.id))}"] .pl-sub`);
    if (sub){ sub.textContent = `${cnt} ${pluralEn(cnt,'item','items')}`; }
    playlists[idx].items_count = cnt;
    savePlaylistsToStorage?.();
  });
}

/* click handlers on grid */
playlistsGrid && playlistsGrid.addEventListener('click', (e)=>{
  const editBtn = e.target.closest('.pl-edit');
  const delBtn  = e.target.closest('.pl-del');
  const card    = e.target.closest('.pl-card');
  if (!card) return;

  const id = card.dataset.id;
  if (editBtn) {
    const pl = playlists.find(p => String(p.id) === String(id));
    if (pl) openPlaylistEditModal(pl);
  } else if (delBtn) {
    deletePlaylist(id);
  }
});

/* ====================== Fetch playlist items (detail) ====================== */
/* ====================== Playlists: fetch playlist items (detail) ====================== */
async function fetchPlaylistTracks(id){
  const key = String(id);

  const stored = getPlItems(key);
  if (stored.length) return stored.map(x => normMediaItem(x));

  try{
    const pl = (playlists || []).find(p => String(p.id) === key);
    if (pl && Array.isArray(pl.tracks) && pl.tracks.length){
      return pl.tracks.map(x => normMediaItem(x));
    }
  }catch(_){}

  async function tryUrl(url, typeHint){
    try{
      const r = await fetch(url, {credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!r.ok) return null;
      const d = await r.json();
      const list = d?.tracks ?? d?.items ?? d?.results ?? d?.data ?? (Array.isArray(d) ? d : null);
      if (!Array.isArray(list)) return null;
      return list.map(x => normMediaItem(x, typeHint));
    }catch{ return null; }
  }

  let out = await tryUrl(`/api/playlists/${encodeURIComponent(key)}/?full=1`, null)
         || await tryUrl(`/api/playlists/${encodeURIComponent(key)}/tracks/`, 'track')
         || await tryUrl(`/api/playlists/${encodeURIComponent(key)}/`, null);

  out = out || [];
  if (out.length) setPlItems(key, out);
  return out;
}


/* ====================== Open edit modal ====================== */
async function openPlaylistEditModal(pl){
  resetPlaylistForm();

  // заголовки/картинка
  if (plTitle) plTitle.value = pl.title || '';
  if (plDesc)  plDesc.value  = pl.description || pl.desc || '';
  if (plCoverPrev){
    if (pl.cover_url){ plCoverPrev.src = pl.cover_url; plCoverPrev.style.display = 'block'; }
    else { plCoverPrev.src = ''; plCoverPrev.style.display = 'none'; }
  }

  if (plForm){
    plForm.dataset.editId = String(pl.id);
    const btn = plForm.querySelector('[type="submit"]');
    if (btn){ btn.textContent = 'Save changes'; btn.classList.add('saving-as-edit'); }
  }

  if (plModal?.style) plModal.style.display = 'flex';
  let items = getPlItems(pl.id);
  if (!items.length && Array.isArray(pl.tracks)) items = pl.tracks;
  if (!items.length) items = await fetchPlaylistTracks(pl.id);

  // сначала пустим UI, потом наполним
  selectedTracksMap.clear();
  updateSelectedChips();

  // сначала — локальный кэш/поле tracks, потом сервер
  let serverTracks =
    (Array.isArray(pl.tracks) && pl.tracks.length ? pl.tracks : getPlItems(pl.id));

  if (!serverTracks.length){
    serverTracks = await fetchPlaylistTracks(pl.id);
  }
  // заполняем Map ключами вида type:id
  (items || []).forEach(raw => {
    const it = normMediaItem(raw);
    if (it) selectedTracksMap.set(`${it.type}:${it.id}`, it);
  });

  (serverTracks || []).forEach(raw=>{
    const it = normMediaItem(raw);
    if (!it) return;
    selectedTracksMap.set(mediaKey(it), it);
  });

  migrateSelectedMapKeys();
  updateSelectedChips();
  ensurePlaylistSearchBinding();
  searchTracksDebounced();
}

/* ====================== Delete playlist ====================== */
async function deletePlaylist(id){
  if (!id) return;
  if (!confirm('Удалить плейлист?')) return;

  try{
    const res = await fetch(`/api/playlists/delete/${encodeURIComponent(id)}/`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || ('HTTP ' + res.status));

    playlists = playlists.filter(p => String(p.id) !== String(id));
    savePlaylistsToStorage();
    renderPlaylistsGrid();
  }catch(err){
    console.error(err);
    alert(err.message || 'Network error while deleting playlist');
  }
}
// отключить встроенную валидацию для форм аудиокниг
document.getElementById('audiobookEditForm')?.setAttribute('novalidate','novalidate');
document.getElementById('audiobookCreateForm')?.setAttribute('novalidate','novalidate');

// мягкая маска для Chapter (не блокирует submit)
['abe_chapter','ab_chapter'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', ()=>{ el.value = el.value.replace(/[^\d]/g,''); });
});

function renderAudiobooks(list){
  const tbody = document.getElementById('audiobooks-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  (list||[]).forEach((ab, index)=>{
    const src = ab.audio_file || '';
    const timeLabel = Number(ab.duration_seconds) ? formatDuration(Number(ab.duration_seconds)) : '0:00';

    const tr = document.createElement('tr');
    tr.dataset.id = ab.id;
    tr.innerHTML = `
      <td><input type="checkbox" class="row-select" data-id="${ab.id}"></td>
      <td class="ab-name">${ab.title||''}</td>
      <td>${ab.author||''}</td>
      <td>${ab.genreid||''}</td>
      <td>${ab.chapter ?? ''}</td>
      <td>${ab.playsnum||0}</td>
      <td class="col-adult"><input type="checkbox" class="adult-toggle" ${ab.adult?'checked':''} onchange="setAudiobookAdult('${ab.id}', this)"></td>
      <td>${ab.id}</td>
      <td class="col-time">${timeLabel}</td>
      <td>
        <button class="action-btn ab-play-btn" data-src="${src}" onclick="playAB(${index}, this)" title="Play/Pause">
          <img src="/media/iconsLuniTune/Group 132.png" width="16" height="16">
        </button>
      </td>
      <td>
        <button class="action-btn" onclick="startEditAudiobook('${ab.id}')"><img src="/media/iconsLuniTune/edit.png" width="16" height="16"> Edit</button>
        <button class="action-btn delete-btn" onclick="deleteAudiobook('${ab.id}')"><img src="/media/iconsLuniTune/close.png" width="16" height="16"> Delete</button>
      </td>`;
    tbody.appendChild(tr);

    const timeCell = tr.querySelector('.col-time');
    if (timeCell && src && !Number(ab.duration_seconds)) {
      ensureTrackDuration({id: ab.id, time: timeLabel}, src, timeCell);
    }
  });

  const selAll = document.getElementById('select-all-audiobooks');
  if (selAll) selAll.checked = false;
}

function renderAudiobooksPager(){
  renderPager('audiobooks-pagination', abPage, abTotalPages, (p)=>{ abPage = p; loadAudiobooksFromServer(); }, true);
}
function getSelectedAudiobookIds(){
  return Array.from(document.querySelectorAll('#audiobooks-tbody .row-select:checked'))
    .map(cb => cb.dataset.id || cb.closest('tr')?.dataset.id)
    .filter(Boolean);
}
/* ====================== Audiobooks: load & render ====================== */
async function loadAudiobooksFromServer(){
  const params = new URLSearchParams();
  if (abSearch) params.set('q', abSearch);
  params.set('page', abPage);
  params.set('page_size', abPerPage);

  const res = await fetch('/api/audiobooks/?wrap=1&' + params.toString());
  const data = await res.json();
  if (!res.ok || !data.success) { console.error(data?.error || res.status); return; }

  audiobooks   = data.items || (Array.isArray(data) ? data : []);
  abPage       = data.page || 1;
  abPerPage    = data.page_size || abPerPage;
  abTotalPages = data.total_pages || Math.max(1, Math.ceil((data.total||audiobooks.length)/abPerPage));

  renderAudiobooks(audiobooks);
  renderAudiobooksPager();
}
async function setAudiobookAdult(id, el){
  const value = el.checked;
  try{
    const fd = new FormData();
    fd.append('adult', value ? 'true' : 'false');
    const res = await fetch(`/api/audiobooks/update/${encodeURIComponent(id)}/`, {
      method:'POST',
      headers:{'X-CSRFToken': getCookie('csrftoken')},
      body: fd
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || res.status);
  }catch(e){
    console.error(e); el.checked = !value;
  }
}
let abCurrentIndex = null;
function playAB(i, btn){
  const src = btn.dataset.src;
  if (!src){ alert('No audio'); return; }
  if (abCurrentIndex === i && !player.paused){ player.pause(); return; }
  if (player.src !== src) player.src = src;
  player.play().then(() => {
    abCurrentIndex = i;
    currentIndex = null;
    pcCurrentIndex = null;
    refreshAllPlayButtons();
  }).catch(console.error);
}

/* CRUD audiobooks */
btnOpenCreateAudiobook?.addEventListener('click', openAudiobookCreateModal);
function openAudiobookCreateModal(){ document.getElementById('audiobookCreateModal').style.display='flex'; }
function closeAudiobookCreateModal(){ document.getElementById('audiobookCreateModal').style.display='none'; document.getElementById('audiobookCreateForm')?.reset(); }
function openAudiobookEditModal(){ document.getElementById('audiobookEditModal').style.display='flex'; }
function closeAudiobookEditModal(){ document.getElementById('audiobookEditModal').style.display='none'; document.getElementById('audiobookEditForm')?.reset(); }

document.getElementById('audiobookCreateForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  fd.append('title',   (document.getElementById('ab_title').value||'').trim());
  fd.append('author',  (document.getElementById('ab_author').value||'').trim());
  fd.append('genreid', (document.getElementById('ab_genreid').value||'').trim());
  fd.append('chapter', (document.getElementById('ab_chapter').value||'').trim());  // NEW
  fd.append('info',    (document.getElementById('ab_info').value||'').trim());
  const af = document.getElementById('ab_audio')?.files?.[0];
  const cf = document.getElementById('ab_cover')?.files?.[0];
  if (af) fd.append('audio_file', af);
  if (cf) fd.append('cover_image', cf);

  const res = await fetch('/api/audiobooks/create/', { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Create error: ' + (data.error || res.status));
  closeAudiobookCreateModal();
  abPage = 1; loadAudiobooksFromServer();
});


function startEditAudiobook(id){
  const u = audiobooks.find(x => String(x.id) === String(id));
  if (!u) return;

  const set = (inputId, val='') => {
    const el = document.getElementById(inputId);
    if (el) el.value = val ?? '';
  };

  set('abe_id',      u.id);
  set('abe_title',   u.name || '');
  set('abe_author',  u.artistid || '');
  set('abe_genreid', u.genreid || '');
  set('abe_chapter', u.chapter ?? '');   // <— новое поле
  set('abe_info',    u.info || '');

  openAudiobookEditModal();
}


document.getElementById('audiobookEditForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('abe_id').value;
  const fd = new FormData();
  fd.append('title',   (document.getElementById('abe_title').value||'').trim());
  fd.append('author',  (document.getElementById('abe_author').value||'').trim());
  fd.append('genreid', (document.getElementById('abe_genreid').value||'').trim());
  fd.append('chapter', (document.getElementById('abe_chapter').value||'').trim()); // ← здесь chapter
  fd.append('info',    (document.getElementById('abe_info').value||'').trim());
  const af = document.getElementById('abe_audio')?.files?.[0];
  const cf = document.getElementById('abe_cover')?.files?.[0];
  if (af) fd.append('audio_file', af);
  if (cf) fd.append('cover_image', cf);

  const res  = await fetch(`/api/audiobooks/update/${encodeURIComponent(id)}/`, {
    method:'POST',
    headers:{'X-CSRFToken': getCookie('csrftoken')},
    body: fd
  });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Update error: ' + (data.error || res.status));
  closeAudiobookEditModal();
  loadAudiobooksFromServer();
});



async function deleteAudiobook(id){
  if (!confirm('Delete this audiobook?')) return;
  const res = await fetch(`/api/audiobooks/delete/${encodeURIComponent(id)}/`, { method:'DELETE', headers:{'X-CSRFToken': getCookie('csrftoken')} });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Delete error: ' + (data.error || res.status));
  loadAudiobooksFromServer();
}
async function bulkDeleteAudiobooks(){
  const ids = getSelectedAudiobookIds();
  if (!ids.length) return alert('Выберите хотя бы одну аудиокнигу.');
  if (!confirm(`Удалить выбранные (${ids.length})?`)) return;
  const res = await fetch('/api/audiobooks/bulk_delete/', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
    body: JSON.stringify({ ids })
  });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Bulk delete error: ' + (data.error || res.status));
  loadAudiobooksFromServer();
}
document.getElementById('select-all-audiobooks')?.addEventListener('change', function(){
  document.querySelectorAll('#audiobooks-tbody .row-select').forEach(cb => cb.checked = this.checked);
});
const runAbSearch = debounce(()=>{
  abPage = 1;
  abSearch = (searchAudiobookInput?.value || '').trim();
  loadAudiobooksFromServer();
}, 300);
searchAudiobookInput?.addEventListener('input', runAbSearch);

/* ====================== Podcasts UI ====================== */
function renderPodcasts(list){
  const tbody = document.getElementById('podcasts-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  (list||[]).forEach((pc, index)=>{
    const src = pc.audio_file || '';
    const timeLabel = Number(pc.duration_seconds) ? formatDuration(Number(pc.duration_seconds)) : '0:00';

    const tr = document.createElement('tr');
    tr.dataset.id = pc.id;

    tr.innerHTML = `
      <td><input type="checkbox" class="row-select" data-id="${pc.id}"></td>
      <td class="pc-name">${pc.title || ''}</td>
      <td>${pc.host || ''}</td>
      <td>${pc.genreid || ''}</td>
      <td>${pc.episode ?? ''}</td>
      <td>${pc.playsnum || 0}</td>
      <td class="col-adult"><input type="checkbox" class="adult-toggle" ${pc.adult?'checked':''} onchange="setPodcastAdult('${pc.id}', this)"></td>
      <td>${pc.id}</td>
      <td class="col-time">${timeLabel}</td>
      <td>
        <button class="action-btn pc-play-btn" data-src="${src}" onclick="playPC(${index}, this)" title="Play/Pause">
          <img src="/media/iconsLuniTune/Group 132.png" width="16" height="16">
        </button>
      </td>
      <td>
        <button class="action-btn" onclick="startEditPodcast('${pc.id}')"><img src="/media/iconsLuniTune/edit.png" width="16" height="16"> Edit</button>
        <button class="action-btn delete-btn" onclick="deletePodcast('${pc.id}')"><img src="/media/iconsLuniTune/close.png" width="16" height="16"> Delete</button>
      </td>`;
    tbody.appendChild(tr);

    const timeCell = tr.querySelector('.col-time');
    if (timeCell && src && !Number(pc.duration_seconds)) {
      ensureTrackDuration({id: pc.id, time: timeLabel}, src, timeCell);
    }
  });

  const selAll = document.getElementById('select-all-podcasts');
  if (selAll) selAll.checked = false;
}
function renderPodcastsPager(){
  renderPager('podcasts-pagination', pcPage, pcTotalPages, (p)=>{ pcPage = p; loadPodcastsFromServer(); }, true);
}
function getSelectedPodcastIds(){
  return Array.from(document.querySelectorAll('#podcasts-tbody .row-select:checked'))
    .map(cb => cb.dataset.id || cb.closest('tr')?.dataset.id)
    .filter(Boolean);
}
/* ====================== Podcasts: load & render ====================== */
async function loadPodcastsFromServer(){
  const params = new URLSearchParams();
  if (pcSearch) params.set('q', pcSearch);
  params.set('page', pcPage);
  params.set('page_size', pcPerPage);

  const res = await fetch('/api/podcasts/?wrap=1&' + params.toString());
  const data = await res.json();
  if (!res.ok || !data.success) { console.error(data?.error || res.status); return; }

  podcasts    = data.items || (Array.isArray(data) ? data : []);
  pcPage      = data.page || 1;
  pcPerPage   = data.page_size || pcPerPage;
  pcTotalPages= data.total_pages || Math.max(1, Math.ceil((data.total||podcasts.length)/pcPerPage));

  renderPodcasts(podcasts);
  renderPodcastsPager();
}
async function setPodcastAdult(id, el){
  const value = el.checked;
  try{
    const fd = new FormData();
    fd.append('adult', value ? 'true' : 'false');
    const res = await fetch(`/api/podcasts/update/${encodeURIComponent(id)}/`, {
      method:'POST',
      headers:{'X-CSRFToken': getCookie('csrftoken')},
      body: fd
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || res.status);
  }catch(e){
    console.error(e); el.checked = !value;
  }
}
let pcCurrentIndex = null;
function playPC(i, btn){
  const src = btn.dataset.src;
  if (!src){ alert('No audio'); return; }
  if (pcCurrentIndex === i && !player.paused){ player.pause(); return; }
  if (player.src !== src) player.src = src;
  player.play().then(() => {
    pcCurrentIndex = i;
    currentIndex = null;
    abCurrentIndex = null;
    refreshAllPlayButtons();
  }).catch(console.error);
}

/* CRUD podcasts */
btnOpenCreatePodcast?.addEventListener('click', openPodcastCreateModal);
function openPodcastCreateModal(){ document.getElementById('podcastCreateModal').style.display='flex'; }
function closePodcastCreateModal(){ document.getElementById('podcastCreateModal').style.display='none'; document.getElementById('podcastCreateForm')?.reset(); }
function openPodcastEditModal(){ document.getElementById('podcastEditModal').style.display='flex'; }
function closePodcastEditModal(){ document.getElementById('podcastEditModal').style.display='none'; document.getElementById('podcastEditForm')?.reset(); }

document.getElementById('podcastCreateForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  fd.append('title',   (document.getElementById('pc_title').value||'').trim());
  fd.append('host',    (document.getElementById('pc_host').value||'').trim());
  fd.append('genreid', (document.getElementById('pc_genreid').value||'').trim());
  fd.append('episode', (document.getElementById('pc_episode').value||'').trim());
  fd.append('info',    (document.getElementById('pc_info').value||'').trim());
  const af = document.getElementById('pc_audio')?.files?.[0];
  const cf = document.getElementById('pc_cover')?.files?.[0];
  if (af) fd.append('audio_file', af);
  if (cf) fd.append('cover_image', cf);

  const res  = await fetch('/api/podcasts/create/', { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Create error: ' + (data.error || res.status));
  closePodcastCreateModal();
  pcPage = 1; loadPodcastsFromServer();
});

function startEditPodcast(id){
  const u = podcasts.find(x => String(x.id) === String(id));
  if (!u) return;

  // у API: name=title, artistid=host, albumid="" (нет show)
  document.getElementById('pce_id').value        = u.id;
  document.getElementById('pce_title').value     = u.name || '';
  document.getElementById('pce_host').value      = u.artistid || u.host || '';  // host              // если поле в форме есть — просто оставим пустым
  document.getElementById('pce_genreid').value   = u.genreid || '';
  document.getElementById('pce_episode').value   = (u.seqnum ?? u.episode ?? '');
  document.getElementById('pce_info').value      = u.info || '';

  // НЕ ТРОГАЕМ pce_tagsid — этого поля нет
  openPodcastEditModal();
}

document.getElementById('podcastEditForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('pce_id').value;

  const fd = new FormData();
  fd.append('title',   document.getElementById('pce_title').value.trim());
  fd.append('host',    document.getElementById('pce_host').value.trim());
  fd.append('genreid', document.getElementById('pce_genreid').value.trim());
  fd.append('episode', document.getElementById('pce_episode').value.trim());

  const af = document.getElementById('pce_audio')?.files?.[0];
  const cf = document.getElementById('pce_cover')?.files?.[0];
  if (af) fd.append('audio_file', af);
  if (cf) fd.append('cover_image', cf);

  const res = await fetch(`/api/podcasts/update/${encodeURIComponent(id)}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') },
    body: fd
  });
  const data = await res.json();
  if (!res.ok || !data.success) {
    alert('Error updating podcast: ' + (data.error || res.status));
    return;
  }
  // перезагрузка списка и закрытие
  await loadPodcastsFromServer();
  closePodcastEditModal();
});

async function deletePodcast(id){
  if (!confirm('Delete this episode?')) return;
  const res = await fetch(`/api/podcasts/delete/${encodeURIComponent(id)}/`, { method:'DELETE', headers:{'X-CSRFToken': getCookie('csrftoken')} });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Delete error: ' + (data.error || res.status));
  loadPodcastsFromServer();
}
async function bulkDeletePodcasts(){
  const ids = getSelectedPodcastIds();
  if (!ids.length) return alert('Выберите хотя бы один эпизод.');
  if (!confirm(`Удалить выбранные (${ids.length})?`)) return;
  const res = await fetch('/api/podcasts/bulk_delete/', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
    body: JSON.stringify({ ids })
  });
  const data = await res.json();
  if (!res.ok || !data.success) return alert('Bulk delete error: ' + (data.error || res.status));
  loadPodcastsFromServer();
}
document.getElementById('select-all-podcasts')?.addEventListener('change', function(){
  document.querySelectorAll('#podcasts-tbody .row-select').forEach(cb => cb.checked = this.checked);
});
const runPcSearch = debounce(()=>{
  pcPage = 1;
  pcSearch = (searchPodcastInput?.value || '').trim();
  loadPodcastsFromServer();
}, 300);
searchPodcastInput?.addEventListener('input', runPcSearch);

/* ====================== Init ====================== */
document.addEventListener('DOMContentLoaded', ()=>{
  toggleSubmenu('elements');
  formatBtnRange();
  updateFiltersBtnState();
  route(); // показываем нужную секцию
});
window.addEventListener('click', (e)=>{
  const m = document.getElementById('modal');
  if(e.target===m) m.style.display='none';
  if (plModal && e.target === plModal) closePlaylistCreateModal();
});

/* ====================== Sidebar submenu toggle & moods ====================== */
function toggleSubmenu(id){
  const submenu = document.getElementById(id);
  if (!submenu) return;
  const button = submenu.previousElementSibling;
  submenu.classList.toggle('open');
  button?.classList.toggle('open');
  document.querySelectorAll('.submenu').forEach(m=>{ if(m.id!==id) m.classList.remove('open') });
  document.querySelectorAll('.menu-item.expandable').forEach(b=>{ if(b!==button) b.classList.remove('open') });
}
function showMoodsSection(){
  hideDashOverview()
  const d  = document.getElementById('dashboard-section');
  const c  = document.getElementById('customers-section');
  const p  = document.getElementById('playlists-section');
  const m  = document.getElementById('moods-section');
  const ab = document.getElementById('audiobooks-section');
  const pc = document.getElementById('podcasts-section');

  if (d) d.style.display = 'none';
  if (c) c.style.display = 'none';
  if (p) p.style.display = 'none';
  if (ab) ab.style.display = 'none';
  if (pc) pc.style.display = 'none';
  if (m) m.style.display = 'block';
  setListTitle('Moods', '', 'moods-section');
}

/* ====================== Router (единственный) ====================== */
function route(){
  const hash = (location.hash || '#tracks').toLowerCase();

  // если уходим с #artists — спрячем всё, что могло остаться на дашборде
  if (hash !== '#artists') {
    const ad = document.getElementById('artist-detail');
    if (ad) ad.style.display = 'none';
    const arSec = document.getElementById('artists-section');
    if (arSec) arSec.style.display = 'none';
    const arPanel = document.getElementById('artists-table')?.closest('.panel');
    if (arPanel) arPanel.style.display = 'none';
  }

  if      (hash === '#dashboard')  showDashboardSection();
  else if (hash === '#artists')    showArtistsSection();
  else if (hash === '#customers')  showCustomersSection();
  else if (hash === '#playlists')  showPlaylistsSection();
  else if (hash === '#audiobooks') showAudiobooksSection();
  else if (hash === '#podcasts')   showPodcastsSection();
  else if (hash === '#moods')      showMoodsSection();
  else                             showTracksSection();
}

function hideDashOverview(){
  const over = document.getElementById('dash-overview'); 
  if(over) over.style.display = 'none';
}
function hideAllSections() {
  [
    'dashboard-section','customers-section','playlists-section',
    'audiobooks-section','podcasts-section','moods-section','artists-section',
    'dash-overview' // если надо гарантированно спрятать и даш-обзор
  ].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
}
window.addEventListener('hashchange', route);

/* ====================== Customers: Filters popover ====================== */
function openCustomerFiltesPopover(){
  if(!customerFiltersPopover || !filtersBtnCustomers) return;

  if(filterRole) filterRole.value = customerFilters.role || '';

  if(customerFiltersPopover.parentElement !== document.body){
    document.body.appendChild(customerFiltersPopover);
  }
  
  customerFiltersPopover.style.position  = 'fixed';
  customerFiltersPopover.style.bottom    = 'auto';
  customerFiltersPopover.style.right     = 'auto';
  customerFiltersPopover.style.transform = 'none';

  customerFiltersPopover.hidden = false; 

  const r = filtersBtnCustomers.getBoundingClientRect(); 
  const pw = customerFiltersPopover.offsetWidth || 280; 
  const ph = customerFiltersPopover.offsetHeight || 200; 
  const margin = 0; 

  let left = r.left; 
  let top  = r.bottom + 8; 

  if(left + pw + margin > window.innerWidth){
    left = Math.max(margin, window.innerWidth - pw - margin); 
  }
  if(top + ph + margin > window.innerHeight){
    top = Math.max(margin, r.top - ph - 8); 
  }

  customerFiltersPopover.style.left = `${left}px`; 
  customerFiltersPopover.style.top = `${top}px`;
 }
 filtersBtnCustomers?.addEventListener('click', () =>{
   if(!customerFiltersPopover) return; 
   customerFiltersPopover.hidden 
     ? openCustomerFiltesPopover()
     : (customerFiltersPopover.hidden = true); 
 })
 
 document.addEventListener('click', (e) =>{
   if(!customerFiltersPopover || customerFiltersPopover.hidden) return; 
   if(!customerFiltersPopover.contains(e.target) && 
      !filtersBtnCustomers?.contains(e.target)){
     customerFiltersPopover.hidden = true; 
    }
 })
window.addEventListener('resize', () => {
  if(customerFiltersPopover && !customerFiltersPopover.hidden){
    openCustomerFiltesPopover();
  }
})
document.getElementById('customerFiltersApply')?.addEventListener('click', () => {
  customerFilters.role = (filterRole?.value || '').trim().toLowerCase();
  custPage = 1;
  if (customerFiltersPopover) customerFiltersPopover.hidden = true;
  loadCustomersFromServer(); // он сам вызовет renderCustomers()
});

document.getElementById('customerFiltersClear')?.addEventListener('click', () => {
  customerFilters.role = '';
  if (filterRole) filterRole.value = '';
  custPage = 1;
  if (customerFiltersPopover) customerFiltersPopover.hidden = true;
  loadCustomersFromServer();
});
function showSection(id) {
  SECTIONS.forEach(s => {
    const el = document.getElementById(s);
    if (el) el.style.display = (s === id ? 'block' : 'none');
  });
  if (id === 'customers-section') {
    loadCustomersFromServer();
  }
}

// Переключение по hash
function handleHash() {
  const id = (location.hash || '').replace(/^#/, '');
  if (SECTIONS.includes(id)) showSection(id);
}

// Навешиваем клик на пункт меню "Customers"
document.addEventListener('click', (e) => {
  const link = e.target.closest && e.target.closest('#nav-customers');
  if (link) {
    e.preventDefault();
    location.hash = '#customers-section';
    handleHash(); // сразу показать и загрузить
  }
});
window.addEventListener('click', (e)=>{
  const em = document.getElementById('editModal');
  if (e.target === em) closeEditModal();
});
const SECTIONS = [
  'dashboard-section',
  'audiobooks-section',
  'podcasts-section',
  'artists-section',
  'customers-section',
  'playlists-section',
];

/* ====================== Artists (ArtistLinks) ====================== */
let artists = [];
let arPage = 1, arPerPage = 10, arTotalPages = 1;
let arSearch = '';

const navArtists =
  document.getElementById('nav-artists') ||
  document.querySelector('[data-nav="artists"]') ||
  document.querySelector('#elements .menu-item[data-by="artistid"]'); // fallback: старый пункт Authors

const searchArtistInput      = document.getElementById('searchArtistInput');
const btnOpenCreateArtist    = document.getElementById('btn-open-create-artist');

function showArtistsSection(){
  hideDashOverview();
  hideAllSections()
  const arSec = document.getElementById('artists-section');
  const inDashboard = !arSec; // artists живёт внутри #dashboard-section

  if (!inDashboard) {
    // стандартно: скрываем остальные секции и показываем artists-section
    ['dashboard-section','customers-section','playlists-section',
     'audiobooks-section','podcasts-section','moods-section']
      .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
    arSec.style.display = 'block';
    setListTitle('Artists', 'All artists', 'artists-section');
  } else {
    // artists встроен в дашборд — дашборд не трогаем
    const d = document.getElementById('dashboard-section');
    if (d) d.style.display = 'block';
    setListTitle('Artists', 'All artists', 'dashboard-section');
    // можно проскроллить к таблице:
    document.getElementById('artists-table')?.scrollIntoView({behavior:'smooth', block:'start'});
  }

  if (!window._artistsLoadedOnce){ window._artistsLoadedOnce = true; loadArtistsFromServer(); }
}


navArtists?.addEventListener('click', (e)=>{
  e.preventDefault();
  if (location.hash.toLowerCase() !== '#artists') location.hash = '#artists';
});

// Если остался старый пункт «Authors» (data-by="artistid"), принудительно ведём в #artists
document.querySelector('#elements .menu-item[data-by="artistid"]')?.addEventListener('click', (e)=>{
  e.preventDefault();
  location.hash = '#artists';
});

/* ---- API ---- */
async function loadArtistsFromServer(){
  const params = new URLSearchParams();
  if (arSearch) params.set('search', arSearch);
  params.set('page', arPage);
  params.set('page_size', arPerPage);

  try{
    const res = await fetch('/api/artists/?' + params.toString(), { credentials:'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'} });
    const data = await res.json();
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }

    // Унификация ответа
    const items = data.items || data.results || data.data || [];
    artists     = items;
    arPage      = data.page || Number(data.current_page) || arPage;
    arPerPage   = data.page_size || arPerPage;
    arTotalPages= data.total_pages || Math.max(1, Math.ceil((data.total || items.length)/arPerPage));

    renderArtists(artists);
    renderPager('artists-pagination', arPage, arTotalPages, (p)=>{ arPage = p; loadArtistsFromServer(); }, true);

    const selAll = document.getElementById('select-all-artists');
    if (selAll) selAll.checked = false;
  }catch(err){
    console.error('Artists load failed:', err);
  }
}

/* ---- Render ---- */
function renderArtists(items) {
  const tbody = document.getElementById('artists-tbody');
  tbody.innerHTML = '';
  items.forEach(a => {
    const ls = (a.listeners ?? a.listener ?? '0');
    const tr = document.createElement('tr');
    tr.dataset.id = a.id;
    tr.innerHTML = `
      <td><input type="checkbox" class="row-select" data-id="${escapeHtml(String(a.id))}"></td>
      <td>${a.photo ? `<img src="${a.photo}" alt="" style="height:40px;border-radius:6px;">` : ''}</td>
      <td>${escapeHtml(a.name || '')}</td>
      <td>${escapeHtml(a.description || '')}</td>
      <td>${escapeHtml(ls)}</td>
      <td>${escapeHtml(String(a.id))}</td>
      <td>
        <button class="btn btn-sm btn-primary" data-edit="${a.id}">Edit</button>
        <button class="btn btn-sm btn-danger" data-del="${a.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // обработчики на кнопки
  tbody.querySelectorAll('[data-edit]').forEach(b => {
    b.addEventListener('click', e => startEditArtist(e.currentTarget.dataset.edit));
  });
  tbody.querySelectorAll('[data-del]').forEach(b => {
    b.addEventListener('click', e => deleteArtist(e.currentTarget.dataset.del));
  });
}


// состояние активного артиста
let _adActiveId = null;

async function openArtistDetail(artistId){
  _adActiveId = artistId;

  const modal = document.getElementById('artistDetailModal');
  const wrap  = document.getElementById('artist-detail');

  const nameEl = document.getElementById('ad-name');
  const imgEl  = document.getElementById('ad-photo');
  const cTr    = document.getElementById('ad-count-tracks');
  const cAb    = document.getElementById('ad-count-ab');
  const cPc    = document.getElementById('ad-count-pc');
  const tBody  = document.getElementById('ad-tracks');
  const abBody = document.getElementById('ad-ab');
  const pcBody = document.getElementById('ad-pc');

  // заглушка UI
  nameEl.textContent = 'Loading...';
  imgEl.style.display = 'none';
  tBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
  abBody.innerHTML = '';
  pcBody.innerHTML = '';

  // показать модалку
  if (modal) modal.style.display = 'flex';

  // сброс активной вкладки на Tracks
document.querySelectorAll('#artist-detail .ad-tab').forEach((b,i)=>{
  b.classList.toggle('active', i===0);
});

  document.getElementById('ad-tab-tracks').style.display = 'block';
  document.getElementById('ad-tab-audiobooks').style.display = 'none';
  document.getElementById('ad-tab-podcasts').style.display = 'none';

  try{
    const r = await fetch(`/api/artists/${encodeURIComponent(artistId)}/content/?limit=20`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    const d = await r.json();
    if (!r.ok || !d.success) throw new Error(d.error || ('HTTP '+r.status));
    if (_adActiveId !== artistId) return;

    nameEl.textContent = d.artist?.name || artistId;
    if (d.artist?.photo) { imgEl.src = d.artist.photo; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }

    cTr.textContent = d.counts?.tracks ?? 0;
    cAb.textContent = d.counts?.audiobooks ?? 0;
    cPc.textContent = d.counts?.podcasts ?? 0;

    tBody.innerHTML = (d.tracks || []).map(t => {
      const audioUrl = t.audio_url || t.stream_url || t.audio || t.file || t.src || t.url || '';
      // если пришло "0:00" или ничего — считаем, что надо дотянуть длительность
      const pretty = (t.time && t.time !== '0:00') ? t.time : '';
      const tdAttr = (!pretty && audioUrl) ? ` data-audio="${escapeHtml(audioUrl)}"` : '';
      return `
        <tr>
          <td>${escapeHtml(t.name||'')}</td>
          <td>${escapeHtml([t.artistid, t.genreid].filter(Boolean).join(' • '))}</td>
          <td>${escapeHtml(String(t.playsnum||0))}</td>
          <td${tdAttr}>${pretty || (audioUrl ? '…' : '0:00')}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4">No tracks</td></tr>';
    abBody.innerHTML = (d.audiobooks || []).map(a => {
      const audioUrlRaw =
        a.audio_url || a.stream_url || a.audio || a.track_file ||
        a.file || a.file_url || a.filepath || a.path ||
        a.src || a.url || a.media || a.preview || '';
      const audioUrl = audioUrlRaw ? new URL(audioUrlRaw, location.origin).href : '';

      const val = (a.time ?? a.duration ?? a.length ?? a.seconds);
      const pretty = (typeof val === 'string' && /^\d{1,2}:\d{2}$/.test(val))
        ? val
        : (Number.isFinite(+val) && +val > 0
            ? `${Math.floor(+val/60)}:${String(Math.round(+val%60)).padStart(2,'0')}`
            : '');

      const tdAttr = (!pretty && audioUrl) ? ` data-audio="${escapeHtml(audioUrl)}"` : '';
      return `
        <tr>
          <td>${escapeHtml(a.name||'')}</td>
          <td>${escapeHtml(a.artistid||'')}</td>
          <td>${escapeHtml(String(a.playsnum||0))}</td>
          <td${tdAttr}>${pretty || (audioUrl ? '…' : '0:00')}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4">No audiobooks</td></tr>';

    pcBody.innerHTML = (d.podcasts || []).map(p => {
      const audioUrlRaw =
        p.audio_url || p.stream_url || p.audio || p.track_file ||
        p.file || p.file_url || p.filepath || p.path ||
        p.src || p.url || p.media || p.preview || '';
      const audioUrl = audioUrlRaw ? new URL(audioUrlRaw, location.origin).href : '';

      const val = (p.time ?? p.duration ?? p.length ?? p.seconds);
      const pretty = (typeof val === 'string' && /^\d{1,2}:\d{2}$/.test(val))
        ? val
        : (Number.isFinite(+val) && +val > 0
            ? `${Math.floor(+val/60)}:${String(Math.round(+val%60)).padStart(2,'0')}`
            : '');

      const tdAttr = (!pretty && audioUrl) ? ` data-audio="${escapeHtml(audioUrl)}"` : '';
      return `
        <tr>
          <td>${escapeHtml(p.name||'')}</td>
          <td>${escapeHtml(p.artistid||'')}</td>
          <td>${escapeHtml(String(p.playsnum||0))}</td>
          <td${tdAttr}>${pretty || (audioUrl ? '…' : '0:00')}</td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="4">No podcasts</td></tr>';
    // дочитываем длительность из файла, если стоит data-audio
    tBody.querySelectorAll('td[data-audio]').forEach(td => {
  const url = td.getAttribute('data-audio');
  if (!url) return;

  const a = new Audio();
  a.preload = 'metadata';
  a.src = url;

  const finish = (dur) => {
    let txt = '0:00';
    if (Number.isFinite(dur) && dur > 0) {
      const m = Math.floor(dur / 60);
      const s = Math.round(dur % 60);
      txt = `${m}:${String(s).padStart(2, '0')}`;
    }
    td.textContent = txt;
    td.removeAttribute('data-audio');
  };

  a.addEventListener('loadedmetadata', () => finish(a.duration), { once: true });
  a.addEventListener('error',          () => finish(NaN),        { once: true });
});

    // «Ещё» — как было
    document.getElementById('ad-more-tracks').style.display = (d.counts?.tracks||0) > (d.tracks?.length||0) ? 'inline-flex' : 'none';
    document.getElementById('ad-more-ab').style.display     = (d.counts?.audiobooks||0) > (d.audiobooks?.length||0) ? 'inline-flex' : 'none';
    document.getElementById('ad-more-pc').style.display     = (d.counts?.podcasts||0) > (d.podcasts?.length||0) ? 'inline-flex' : 'none';

    document.getElementById('ad-more-tracks').onclick = ()=>{
      closeArtistDetailModal();
      location.hash = '#dashboard';
      if (typeof setFilterArtist === 'function') setFilterArtist(artistId);
      else { window.filters = window.filters || {}; window.filters.artistid = artistId; loadTracksFromServer && loadTracksFromServer(); }
      document.getElementById('tracks-main-table')?.scrollIntoView({behavior:'smooth', block:'start'});
    };
    document.getElementById('ad-more-ab').onclick = ()=>{
      closeArtistDetailModal();
      location.hash = '#audiobooks';
      window.abPage = 1;
      const params = new URLSearchParams(location.search); params.set('artistid', artistId);
      history.replaceState(null, '', location.pathname + '?' + params.toString() + location.hash);
      loadAudiobooksFromServer && loadAudiobooksFromServer();
    };
    document.getElementById('ad-more-pc').onclick = ()=>{
      closeArtistDetailModal();
      location.hash = '#podcasts';
      window.pcPage = 1;
      const params = new URLSearchParams(location.search); params.set('artistid', artistId);
      history.replaceState(null, '', location.pathname + '?' + params.toString() + location.hash);
      loadPodcastsFromServer && loadPodcastsFromServer();
    };
  }catch(err){
    console.error(err);
    tBody.innerHTML = `<tr><td colspan="4">Error: ${escapeHtml(err.message||'')}</td></tr>`;
  }
}

// вкладки в деталке
document.addEventListener('click', (e)=>{
  const tab = e.target.closest('[data-adtab]');
  if (!tab) return;
  const target = tab.dataset.adtab;
  document.querySelectorAll('#artist-detail .ad-tab').forEach(b=>b.classList.toggle('active', b===tab));
  document.getElementById('ad-tab-tracks').style.display = target==='tracks' ? 'block' : 'none';
  document.getElementById('ad-tab-audiobooks').style.display = target==='audiobooks' ? 'block' : 'none';
  document.getElementById('ad-tab-podcasts').style.display = target==='podcasts' ? 'block' : 'none';
});

// прячем деталку, когда уходим из Artists
function hideArtistDetail(){
  const wrap = document.getElementById('artist-detail');
  if (wrap) wrap.style.display = 'none';
}
window.addEventListener('hashchange', ()=>{
  if (location.hash.toLowerCase() !== '#artists') hideArtistDetail();
});

/* ---- Helpers (select/bulk) ---- */
document.getElementById('select-all-artists')?.addEventListener('change', function(){
  document.querySelectorAll('#artists-tbody .row-select').forEach(cb => cb.checked = this.checked);
});
function getSelectedArtistIds(){
  return Array.from(document.querySelectorAll('#artists-tbody .row-select:checked'))
    .map(cb => cb.dataset.id || cb.closest('tr')?.dataset.id)
    .filter(Boolean);
}
async function bulkDeleteArtists(){
  const ids = getSelectedArtistIds();
  if (!ids.length) return alert('Выберите хотя бы одного артиста.');
  if (!confirm(`Удалить выбранные (${ids.length})?`)) return;

  try{
    const res = await fetch('/api/artists/bulk_delete/', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
      body: JSON.stringify({ ids })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    loadArtistsFromServer();
  }catch(err){
    console.error(err);
    alert('Bulk delete error: ' + err.message);
  }
}

/* ---- Create ---- */
btnOpenCreateArtist?.addEventListener('click', openArtistCreateModal);
function openArtistCreateModal(){ document.getElementById('artistCreateModal')?.style && (document.getElementById('artistCreateModal').style.display='flex'); }
function closeArtistCreateModal(){ 
  const m = document.getElementById('artistCreateModal');
  if (m) m.style.display = 'none';
  document.getElementById('artistCreateForm')?.reset();
}

document.getElementById('artistCreateForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  const id     = (document.getElementById('ar_id')?.value || '').trim();
  const name   = (document.getElementById('ar_name')?.value || '').trim();
  const desc   = (document.getElementById('ar_description')?.value || '').trim();
  const photo  = document.getElementById('ar_photo')?.files?.[0];
  const listen = (document.getElementById('ar_listeners')?.value || '').trim(); // NEW

  if (!name) return alert('Enter artist name');
  if (id) fd.append('id', id);
  fd.append('name', name);
  fd.append('description', desc);
  if (photo) fd.append('photo', photo);
  if (listen) fd.append('listeners', listen); // NEW

  try{
    const res = await fetch('/api/artists/create/', { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    closeArtistCreateModal();
    arPage = 1;
    loadArtistsFromServer();
  }catch(err){
    console.error(err);
    alert('Create error: ' + err.message);
  }
});


/* ---- Edit ---- */
function openArtistEditModal(){ document.getElementById('artistEditModal')?.style && (document.getElementById('artistEditModal').style.display='flex'); }
function closeArtistEditModal(){ 
  const m = document.getElementById('artistEditModal');
  if (m) m.style.display = 'none';
  document.getElementById('artistEditForm')?.reset();
}

async function startEditArtist(id){
  let a = (typeof artists !== 'undefined') ? artists.find(x => String(x.id)===String(id)) : null;
  if (!a) {
    const res = await fetch(`/api/artists/${encodeURIComponent(id)}/`);
    const data = await res.json();
    if (!res.ok || data.error) { alert('Artist not found'); return; }
    a = data;
  }

  document.getElementById('ar_e_id').value = a.id;

  const idView = document.getElementById('ar_e_id_view');
  if (idView){ idView.value = a.id; idView.removeAttribute('readonly'); idView.disabled = false; idView.classList.remove('readonly'); }

  document.getElementById('ar_e_name').value = a.name || '';
  document.getElementById('ar_e_description').value = a.description || '';
  const ls = (a.listeners ?? a.listener ?? '0');                 // NEW
  const lsInput = document.getElementById('ar_e_listeners');      // NEW
  if (lsInput) lsInput.value = ls;                                // NEW

  openArtistEditModal();
}

document.getElementById('artistEditForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const oldId = document.getElementById('ar_e_id').value.trim();
  const newIdInput = document.getElementById('ar_e_id_view') || document.getElementById('ar_e_id_new');
  const newId = newIdInput ? newIdInput.value.trim() : '';

  const fd = new FormData();
  fd.append('name', (document.getElementById('ar_e_name').value || '').trim());
  fd.append('description', (document.getElementById('ar_e_description').value || '').trim());
  const ls = (document.getElementById('ar_e_listeners')?.value || '').trim();     // NEW
  if (ls) fd.append('listeners', ls);                                             // NEW
  if (newId && newId !== oldId) fd.append('new_id', newId);

  const pf = document.getElementById('ar_e_photo')?.files?.[0];
  if (pf) fd.append('photo', pf);

  try {
    const res = await fetch(`/api/artists/${encodeURIComponent(oldId)}/update/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: fd
    });
    let data = null;
    try { data = await res.json(); } catch (_) {}
    const okFlag = data && (data.ok === true || data.success === true);
    if (!res.ok || (data && data.error) || !okFlag) {
      throw new Error((data && data.error) || `HTTP ${res.status}`);
    }
    await loadArtistsFromServer();
    closeArtistEditModal();
  } catch (err) {
    alert('Update artist failed: ' + (err?.message || err));
  }
});



/* ---- Delete ---- */
async function deleteArtist(id){
  if (!confirm('Delete this artist?')) return;
  try{
    const res = await fetch(`/api/artists/${encodeURIComponent(id)}/delete/`, {
      method:'DELETE',
      headers:{'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);
    loadArtistsFromServer();
  }catch(err){
    console.error(err);
    alert('Delete error: ' + err.message);
  }
}

/* ---- Search ---- */
const runArtistSearch = debounce(()=>{
  arPage = 1;
  arSearch = (searchArtistInput?.value || '').trim();
  loadArtistsFromServer();
}, 300);
searchArtistInput?.addEventListener('input', runArtistSearch);

document.getElementById('artist-create-close')?.addEventListener('click', closeArtistCreateModal);
document.getElementById('artist-create-cancel')?.addEventListener('click', closeArtistCreateModal);

document.getElementById('artist-edit-close')?.addEventListener('click', closeArtistEditModal);
document.getElementById('artist-edit-cancel')?.addEventListener('click', closeArtistEditModal);

window.addEventListener('click', (e)=>{
  const mCreate = document.getElementById('artistCreateModal');
  const mEdit   = document.getElementById('artistEditModal');
  if (e.target === mCreate) closeArtistCreateModal();
  if (e.target === mEdit)   closeArtistEditModal();
});
function closeArtistDetailModal(){
  const modal = document.getElementById('artistDetailModal');
  if (modal) modal.style.display = 'none';
  _adActiveId = null;
}

// клик по крестику и фону
document.getElementById('ad-close')?.addEventListener('click', closeArtistDetailModal);
window.addEventListener('click', (e)=>{
  const m = document.getElementById('artistDetailModal');
  if (e.target === m) closeArtistDetailModal();
});
// ESC
window.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') closeArtistDetailModal();
});

// при уходе из #artists — тоже закрываем
window.addEventListener('hashchange', ()=>{
  if (location.hash.toLowerCase() !== '#artists') closeArtistDetailModal();
});

</script>

</body>
</html>
